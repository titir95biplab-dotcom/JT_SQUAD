<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JT Squad Manager v2.1</title>
    
    <!-- Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkp1aWNlIFRoZXJhcHkgU3F1YWQiLAogICJzaG9ydF9uYW1lIjogIkpUIFNxdWFkIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmZmZmZmYiLAogICJ0aGVtZV9jb2xvciIjogIiNmOTczMTYiCn0=">
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Styles -->
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; background-color: #f8fafc; overscroll-behavior-y: contain; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none !important; }
        .loader { border-top-color: #f97316; animation: spinner 1s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .nav-btn { color: #9ca3af; transition: all 0.2s; }
        .nav-btn.active { color: #ea580c; }
        .nav-btn.active i { transform: translateY(-2px); }
        .admin-tab-btn { transition: all 0.2s; border-bottom: 2px solid transparent; color: #6b7280; }
        .admin-tab-btn.active { border-bottom-color: #ea580c; color: #ea580c; font-weight: 700; background-color: #fff7ed; }
        /* Mobile Optimization */
        input, select, button { touch-action: manipulation; }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col text-gray-800">

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 right-5 bg-gray-900 text-white px-4 py-3 rounded-lg shadow-xl transform translate-x-full transition-transform duration-300 z-[100] font-medium flex items-center gap-3 text-sm max-w-xs">
        <i class="fas fa-info-circle text-orange-400 text-lg"></i> <span id="toastMsg">Notification</span>
    </div>

    <!-- Login Screen -->
    <div id="authSection" class="flex-grow flex flex-col items-center justify-center p-6 bg-orange-50 overflow-y-auto">
        <div class="bg-white p-4 rounded-full shadow-lg mb-6"><div class="w-16 h-16 bg-gradient-to-br from-orange-500 to-red-600 rounded-full flex items-center justify-center text-white font-bold text-2xl">JT</div></div>
        <div class="bg-white p-8 rounded-2xl shadow-sm w-full max-w-md border border-gray-100">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-2">Welcome Back</h2>
            <p class="text-center text-gray-400 text-sm mb-6">Staff Management System</p>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">Email</label>
                    <input type="email" id="loginEmail" required class="w-full p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 outline-none transition" placeholder="staff@juicetherapy.com">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">Password</label>
                    <input type="password" id="loginPassword" required class="w-full p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 outline-none transition" placeholder="••••••••">
                </div>
                <button type="submit" class="w-full py-3.5 bg-orange-600 hover:bg-orange-700 text-white rounded-xl font-bold shadow-lg shadow-orange-200 transition transform active:scale-95">Sign In</button>
            </form>
            <p id="authError" class="text-red-500 text-sm mt-4 text-center hidden bg-red-50 p-3 rounded-lg border border-red-100"></p>
        </div>
    </div>

    <!-- Main App Interface -->
    <div id="appLayout" class="flex-grow flex flex-col hidden h-full">
        
        <!-- Top Bar -->
        <header class="bg-white p-4 shadow-sm flex justify-between items-center z-20 border-b border-gray-100 h-16 shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center text-white font-bold text-xs shadow-sm">JT</div>
                <div>
                    <h1 class="font-bold text-sm leading-tight text-gray-800">Juice Therapy</h1>
                    <div class="flex items-center gap-1.5">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                        <p class="text-[10px] text-gray-500 uppercase font-bold tracking-wide" id="headerRoleDisplay">Loading...</p>
                    </div>
                </div>
            </div>
            <div class="flex gap-1">
                <button onclick="window.location.reload()" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-orange-600 hover:bg-orange-50 rounded-full transition"><i class="fas fa-sync-alt text-xs"></i></button>
                <button id="logoutBtn" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full transition"><i class="fas fa-power-off text-xs"></i></button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="mainContent" class="flex-grow overflow-y-auto bg-gray-50 relative pb-24">
            
            <!-- Global Loader -->
            <div id="pageLoader" class="absolute inset-0 flex items-center justify-center bg-white/90 z-50 hidden">
                <div class="flex flex-col items-center">
                    <div class="loader w-10 h-10 rounded-full border-4 border-gray-200 mb-2"></div>
                    <span class="text-xs font-bold text-gray-400">Processing...</span>
                </div>
            </div>

            <!-- ================= ADMIN DASHBOARD ================= -->
            <div id="adminView" class="view-section hidden flex flex-col h-full">
                <!-- Sticky Admin Nav -->
                <div class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-30 overflow-x-auto flex shrink-0">
                    <button class="flex-1 py-3 text-xs font-bold uppercase tracking-wide admin-tab-btn active" onclick="switchAdminTab('overview', event)"><i class="fas fa-chart-pie mb-1 block text-lg"></i>Stats</button>
                    <button class="flex-1 py-3 text-xs font-bold uppercase tracking-wide admin-tab-btn" onclick="switchAdminTab('users', event)"><i class="fas fa-users mb-1 block text-lg"></i>Staff</button>
                    <button class="flex-1 py-3 text-xs font-bold uppercase tracking-wide admin-tab-btn" onclick="switchAdminTab('shifts', event)"><i class="fas fa-clock mb-1 block text-lg"></i>Shifts</button>
                    <button class="flex-1 py-3 text-xs font-bold uppercase tracking-wide admin-tab-btn" onclick="switchAdminTab('requests', event)"><i class="fas fa-envelope-open-text mb-1 block text-lg"></i>Leaves</button>
<!-- Find the Admin Nav buttons and add this new one -->
<button class="flex-1 py-3 text-xs font-bold uppercase tracking-wide admin-tab-btn" onclick="switchAdminTab('clients', event)"><i class="fas fa-store mb-1 block text-lg"></i>Clients</button>
                    <button class="flex-1 py-3 text-xs font-bold uppercase tracking-wide admin-tab-btn" onclick="switchAdminTab('settings', event)"><i class="fas fa-cogs mb-1 block text-lg"></i>Config</button>
                </div>

                <div class="p-4 space-y-5 pb-24">
                    <!-- Tab: Overview / Stats -->
                    <div id="adminTab-overview" class="space-y-4">
                        <div class="grid grid-cols-2 gap-3">
			    
<div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm"><p class="text-gray-400 text-[10px] font-bold uppercase">Fees Collected</p><p class="text-2xl font-bold text-blue-600">₹<span id="adminFeesCollected">0</span></p></div>
                            <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm"><p class="text-gray-400 text-[10px] font-bold uppercase">Total Squad</p><p id="adminTotalSquad" class="text-2xl font-bold text-gray-800">0</p></div>
                            <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm"><p class="text-gray-400 text-[10px] font-bold uppercase">Active Now</p><p id="adminActiveStaff" class="text-2xl font-bold text-green-600">0</p></div>
                            <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm col-span-2"><p class="text-gray-400 text-[10px] font-bold uppercase">Total Liability (Pending Wages)</p><p class="text-2xl font-bold text-gray-800">₹<span id="adminPendingPayout">0</span></p></div>
                        </div>
                        
                        <!-- Schedule Card (Today & Tomorrow) -->
                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                            <div class="p-3 border-b border-gray-50 bg-gray-50/50">
                                <h3 class="font-bold text-xs text-gray-600 uppercase">Squad Schedule (Today & Next Day)</h3>
                            </div>
                            <div id="adminScheduleList" class="p-4 space-y-3">
                                <p class="text-center text-xs text-gray-400 italic">Loading Schedule...</p>
                            </div>
                        </div>
<!-- NEW: Pending Squad Requests Block -->
<div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm mt-4">
    <div class="p-3 border-b border-gray-50 bg-gray-50/50"><h3 class="font-bold text-xs text-blue-600 uppercase">Pending Squad Slot Requests</h3></div>
    <div id="adminSquadRequestList" class="p-4 space-y-3"></div>
</div>
<!-- NEW: Client Service Requests (Admin Assign) -->
    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm mt-4">
        <div class="p-3 border-b border-gray-50 bg-gray-50/50"><h3 class="font-bold text-xs text-purple-600 uppercase">Pending Client Service Requests</h3></div>
        <div id="adminServiceReqList" class="p-4 space-y-3"></div>
    </div>
                    </div>

                    <!-- Tab: Users -->
                    <div id="adminTab-users" class="hidden space-y-4">
                        <div class="flex gap-2">
                            <div class="relative flex-grow">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400 text-xs"></i>
                                <input type="text" id="staffSearch" onkeyup="filterStaffTable()" placeholder="Search staff..." class="w-full pl-8 p-2.5 text-sm rounded-lg border border-gray-200 outline-none focus:border-orange-500">
                            </div>
                            <button onclick="document.getElementById('createUserModal').classList.remove('hidden')" class="bg-gray-800 text-white px-3 rounded-lg shadow"><i class="fas fa-plus"></i></button>
                        </div>
                        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-semibold"><tr><th class="p-3">Staff Details</th><th class="p-3">Financials</th><th class="p-3">Stats</th><th class="p-3 text-right">Actions</th></tr></thead>
                                    <tbody id="userTableBody" class="divide-y divide-gray-100 text-gray-700"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Shifts -->
                    <div id="adminTab-shifts" class="hidden space-y-4">
                        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                            <div class="p-3 border-b border-gray-50 bg-gray-50/50 flex justify-between items-center">
                                <h3 class="font-bold text-xs text-gray-600 uppercase">Recent Activity</h3>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-semibold"><tr><th class="p-3">Date</th><th class="p-3">Staff</th><th class="p-3">Duration</th><th class="p-3 text-right">Action</th></tr></thead>
                                    <tbody id="shiftTableBody" class="divide-y divide-gray-100 text-gray-700"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Requests (Leaves for Admin) -->
                    <div id="adminTab-requests" class="hidden space-y-4">
                        <!-- Pending -->
                        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
                            <div class="p-3 border-b border-gray-50 bg-gray-50/50"><h3 class="font-bold text-xs text-gray-600 uppercase">Pending Leave Requests</h3></div>
                            <div id="adminLeaveList" class="p-4 space-y-3"></div>

                        </div>
                        <!-- Upcoming Approved -->
                        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
                            <div class="p-3 border-b border-gray-50 bg-gray-50/50"><h3 class="font-bold text-xs text-green-600 uppercase">Upcoming Approved Leaves</h3></div>
                            <div id="adminUpcomingLeaveList" class="p-4 space-y-3"></div>
                        </div>
                    </div>


<!-- Tab: Clients -->
<div id="adminTab-clients" class="hidden space-y-4">
    <div class="flex gap-2">
        <div class="relative flex-grow">
            <i class="fas fa-search absolute left-3 top-3 text-gray-400 text-xs"></i>
            <input type="text" id="clientSearch" onkeyup="filterClientTable()" placeholder="Search clients..." class="w-full pl-8 p-2.5 text-sm rounded-lg border border-gray-200 outline-none">
        </div>
        <button onclick="document.getElementById('createClientModal').classList.remove('hidden')" class="bg-gray-800 text-white px-3 rounded-lg shadow"><i class="fas fa-plus"></i></button>
    </div>
    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
                <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-semibold"><tr><th class="p-3">Client Details</th><th class="p-3">Location</th><th class="p-3">Wallet</th><th class="p-3 text-right">Action</th></tr></thead>
                <tbody id="clientTableBody" class="divide-y divide-gray-100 text-gray-700"></tbody>
            </table>
        </div>
    </div>
</div>

                    <!-- Tab: Settings -->
                    <div id="adminTab-settings" class="hidden space-y-4">
                        <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                            <h3 class="font-bold text-gray-800 text-sm uppercase mb-4 border-b pb-2">System Configuration</h3>
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">Base Rate (₹/hr)</label><input type="number" id="settingRate" class="w-full p-2 border rounded font-mono text-sm"></div>
                                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">Bonus (Pts/hr)</label><input type="number" id="settingBonus" class="w-full p-2 border rounded font-mono text-sm"></div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">Geofence (m)</label><input type="number" id="settingRadius" class="w-full p-2 border rounded font-mono text-sm"></div>
                                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">Training (Days)</label><input type="number" id="settingTraining" class="w-full p-2 border rounded font-mono text-sm"></div>
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-gray-400 uppercase">Outlet Location (Lat, Lng)</label>
                                    <div class="flex gap-2">
                                        <input type="number" step="any" id="settingLat" class="w-1/2 p-2 border rounded font-mono text-xs" placeholder="Latitude">
                                        <input type="number" step="any" id="settingLng" class="w-1/2 p-2 border rounded font-mono text-xs" placeholder="Longitude">
                                    </div>
                                    <button onclick="navigator.geolocation.getCurrentPosition(p=>{document.getElementById('settingLat').value=p.coords.latitude;document.getElementById('settingLng').value=p.coords.longitude})" class="text-[10px] text-blue-600 mt-1 underline">Get Current Location</button>
                                </div>
                                <button id="saveSettingsBtn" class="w-full py-3 bg-gray-800 text-white rounded-lg font-bold text-sm hover:bg-black transition">Save Configuration</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ================= MANAGER OPS CONSOLE ================= -->
            <div id="managerView" class="view-section hidden p-4 space-y-5">
                <div class="bg-white p-4 rounded-xl border-l-4 border-orange-500 shadow-sm flex justify-between items-center">
                    <div>
                        <h2 class="text-lg font-bold text-gray-800">Manager Ops</h2>
                        <p class="text-xs text-gray-500" id="mgrDateDisplay">...</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="window.enterMyZone()" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow hover:bg-blue-700 transition"><i class="fas fa-user-circle mr-1"></i> My Zone</button>
                        <button onclick="window.openRedeemModal()" class="bg-orange-100 text-orange-700 w-8 h-8 rounded-lg flex items-center justify-center hover:bg-orange-200"><i class="fas fa-gift"></i></button>
                    </div>
                </div>

                <!-- Live Floor -->
                <div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
                    <div class="p-3 border-b border-gray-50 bg-gray-50/50 flex justify-between items-center">
                        <h3 class="font-bold text-xs text-gray-600 uppercase">Live Floor (Squad)</h3>
                        <span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-[10px] font-bold" id="mgrLiveCount">0 Active</span>
                    </div>
                    <div id="liveWorkersList" class="p-4 space-y-3"><p class="text-center text-gray-400 text-xs italic">Floor is clear.</p></div>
                </div>

                <!-- Squad Schedule -->
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                    <div class="p-3 border-b border-gray-50 bg-gray-50/50">
                        <h3 class="font-bold text-xs text-gray-600 uppercase">Squad Schedule (Today & Next Day)</h3>
                    </div>
                    <div id="mgrScheduleList" class="p-4 space-y-3">
                        <p class="text-center text-xs text-gray-400 italic">Loading Schedule...</p>
                    </div>
                </div>

                <!-- Squad Request Approvals -->
                <div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
                    <div class="p-3 border-b border-gray-50 bg-gray-50/50"><h3 class="font-bold text-xs text-gray-600 uppercase">Squad Slot Requests</h3></div>
                    <div id="slotRequestsList" class="p-4 space-y-3"></div>
                </div>
            </div>


<!-- ================= CLIENT PORTAL ================= -->
<div id="clientView" class="view-section hidden p-4 space-y-5">
    <div class="bg-white p-4 rounded-xl border-l-4 border-blue-600 shadow-sm flex justify-between items-center">
        <div>
            <h2 class="text-lg font-bold text-gray-800" id="clientHeaderName">Client Portal</h2>
            <p class="text-xs text-gray-500">Manage Service Requests</p>
        </div>
        <div class="text-right">
    <p class="text-[10px] uppercase font-bold text-gray-400">Wallet Balance</p>
    <p class="text-xl font-bold text-green-600">₹<span id="clientWalletBalance">0</span></p>
</div>
    </div>

    <!-- Actions -->
    <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
        <h3 class="font-bold text-xs text-gray-400 uppercase mb-3">Request Service</h3>
        <div class="space-y-3">
            <input type="date" id="serviceDate" class="w-full p-2 border rounded text-sm">
            <div class="flex gap-2">
                <input type="time" id="serviceStart" class="w-1/2 p-2 border rounded text-sm">
                <input type="time" id="serviceEnd" class="w-1/2 p-2 border rounded text-sm">
            </div>
            <button onclick="window.requestService()" class="w-full py-3 bg-blue-600 text-white rounded-lg font-bold text-sm">Submit Request</button>
        </div>
    </div>

    <!-- Active Staff -->
    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
        <div class="p-3 border-b border-gray-50 bg-gray-50/50 flex justify-between"><h3 class="font-bold text-xs text-green-600 uppercase">Active Squad Members</h3><span id="clientLiveCount" class="text-xs font-bold">0</span></div>
        <div id="clientLiveList" class="p-4 space-y-3"><p class="text-center text-xs text-gray-400 italic">No active staff currently.</p></div>
    </div>

<!-- Upcoming Services -->
<div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
    <div class="p-3 border-b border-gray-50 bg-gray-50/50"><h3 class="font-bold text-xs text-blue-600 uppercase">Upcoming Service Slots</h3></div>
    <div id="clientUpcomingList" class="p-4 space-y-3"></div>
</div>

    <!-- Request History -->
    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
        <div class="p-3 border-b border-gray-50 bg-gray-50/50"><h3 class="font-bold text-xs text-gray-600 uppercase">Service Status</h3></div>
        <div id="clientRequestList" class="p-4 space-y-3"></div>
    </div>
    
    <!-- Work History -->
    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
        <div class="p-3 border-b border-gray-50 bg-gray-50/50"><h3 class="font-bold text-xs text-gray-600 uppercase">Completed Work History</h3></div>
        <div id="clientWorkHistory" class="p-4 space-y-3"></div>
    </div>
</div>

            <!-- ================= PERSONAL DASHBOARD (ALL STAFF) ================= -->
            <div id="memberDashboard" class="member-tab hidden p-4 space-y-5">
                
                <!-- Back Button for Managers -->
                <button id="mgrBackBtn" class="hidden w-full bg-gray-800 text-white py-3 rounded-xl font-bold text-sm shadow-lg mb-2" onclick="window.exitMyZone()">
                    <i class="fas fa-arrow-left mr-2"></i> Return to Ops Console
                </button>

                <!-- ID Card -->
                <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl p-5 text-white shadow-xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fas fa-id-card fa-6x"></i></div>
                    <div class="relative z-10">
                        <div class="flex items-center gap-4 mb-5">
                            <div class="w-14 h-14 bg-white rounded-full flex items-center justify-center text-orange-600 font-bold text-xl border-4 border-gray-600" id="memberInitials">JT</div>
                            <div>
                                <h2 class="font-bold text-lg leading-tight" id="memberName">Staff Name</h2>
                                <p class="text-xs text-gray-400 font-mono mb-1">ID: <span id="memberId">...</span></p>
                                <span class="bg-orange-600 text-white text-[10px] uppercase font-bold px-2 py-0.5 rounded" id="memberRoleBadge">Role</span>
                            </div>
                        </div>
                        
                        <!-- Dynamic Stats -->
                        <div class="grid grid-cols-3 gap-2 border-t border-gray-700 pt-4" id="statsGrid">
                            <!-- Injected JS -->
                        </div>
                    </div>
                </div>

                <!-- Training Warning -->
                <div id="blockedFundsAlert" class="bg-orange-50 border border-orange-200 rounded-xl p-3 flex items-center gap-3 hidden">
                    <div class="bg-orange-100 text-orange-600 w-8 h-8 rounded-full flex items-center justify-center shrink-0"><i class="fas fa-lock text-xs"></i></div>
                    <div>
                        <p class="text-xs font-bold text-gray-700">Training Wallet Locked</p>
                        <p class="text-[10px] text-gray-500">Held Funds: <span class="font-bold text-gray-800">₹<span id="memberBlockedWallet">0</span></span></p>
                    </div>
                </div>

                <!-- Filter for Full Time Stats -->
                <div id="fullTimeFilter" class="hidden">
                    <select id="statsDateFilter" onchange="window.renderFullTimeStats()" class="w-full p-2 bg-white border rounded text-xs font-bold text-gray-600">
                        <option value="this_month">This Month</option>
                        <option value="last_month">Last Month</option>
                        <option value="all_time">All Time</option>
                    </select>
                </div>


<!-- Job Offers (Assignments) -->
<div id="memberJobOffers" class="bg-yellow-50 border border-yellow-100 rounded-xl p-4 hidden mb-4">
    <h3 class="font-bold text-yellow-800 text-xs uppercase mb-2"><i class="fas fa-bell mr-2"></i>New Job Assignments</h3>
    <div id="memberOfferList" class="space-y-2"></div>
</div>

                <!-- Upcoming Approved Slots (Squad Only) -->
                <div id="memberUpcomingSlotsBox" class="bg-blue-50 border border-blue-100 rounded-xl p-4 hidden">
                    <h3 class="font-bold text-blue-800 text-xs uppercase mb-2"><i class="fas fa-calendar-check mr-2"></i>My Upcoming Slots</h3>
                    <div id="memberUpcomingList" class="space-y-2 text-sm text-blue-700"></div>
                </div>

                <!-- Attendance Action -->
                <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm text-center">
                    <h3 class="font-bold text-xs text-gray-400 uppercase mb-4 tracking-wider">Attendance</h3>
                    
                    <div id="checkInBtnArea">
                        <button id="checkInBtn" class="w-full py-4 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold text-lg shadow-lg shadow-green-100 transition active:scale-95 flex items-center justify-center gap-2">
                            <i class="fas fa-camera"></i> CHECK IN
                        </button>
                        <p class="text-[10px] text-gray-400 mt-2"><i class="fas fa-map-marker-alt mr-1"></i> Location & Face Verified</p>
                    </div>

                    <div id="checkOutBtnArea" class="hidden">
                        <div class="inline-block px-3 py-1 bg-red-50 text-red-600 rounded-full text-xs font-bold mb-3 animate-pulse">ON DUTY</div>
                        <div class="text-4xl font-mono font-bold text-gray-800 mb-4 tracking-tight" id="workTimer">00:00:00</div>
                        <button id="checkOutBtn" class="w-full py-4 bg-gray-900 hover:bg-black text-white rounded-xl font-bold text-lg shadow-lg transition active:scale-95">END SHIFT</button>
                    </div>
                    
                    <p id="geoError" class="text-red-500 text-xs mt-3 hidden bg-red-50 p-2 rounded border border-red-100 font-bold"></p>
                </div>

                <!-- Booking / Leave -->
                <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                    <h3 class="font-bold text-xs text-gray-400 uppercase mb-4 tracking-wider" id="bookingTitle">Book Slot</h3>
                    
                    <!-- Squad Booking UI -->
                    <div id="squadBookingUI" class="hidden space-y-3">
                         <div class="text-xs text-gray-500 text-center mb-2">Bookings allow for <span class="font-bold text-gray-700">Next Day Only</span></div>
                        <div class="flex gap-2">
                            <input type="time" id="bookStartTime" class="w-1/2 p-3 border border-gray-200 rounded-lg bg-gray-50 text-sm">
                            <input type="time" id="bookEndTime" class="w-1/2 p-3 border border-gray-200 rounded-lg bg-gray-50 text-sm">
                        </div>
                        <button id="bookSlotBtn" class="w-full py-3 bg-orange-50 text-orange-600 hover:bg-orange-100 border border-orange-100 rounded-lg font-bold text-sm transition">Request Slot</button>
                    </div>

                    <!-- Full Time Leave UI -->
                    <div id="ftLeaveUI" class="hidden space-y-3">
                        <input type="date" id="leaveDate" class="w-full p-3 border border-gray-200 rounded-lg bg-gray-50 text-sm">
                        <textarea id="leaveReason" class="w-full p-3 border border-gray-200 rounded-lg bg-gray-50 text-sm" placeholder="Reason for leave..."></textarea>
                        <button id="requestLeaveBtn" class="w-full py-3 bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-100 rounded-lg font-bold text-sm transition">Submit Leave Request</button>
                    </div>
                    
                    <!-- Upcoming Status Display -->
                    <div id="requestStatusDisplay" class="mt-4 pt-4 border-t border-gray-100 text-sm hidden">
                        <!-- Filled by JS -->
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="memberHistory" class="member-tab hidden p-4 pb-24 space-y-4">
                <h2 class="text-lg font-bold text-gray-800 px-1">Work History</h2>
                <div id="historyList" class="space-y-3"></div>
            </div>

            <!-- Profile Tab -->
            <div id="memberProfile" class="member-tab hidden p-4 pb-24 space-y-4">
                <div class="bg-white rounded-xl border border-gray-200 p-6 text-center shadow-sm">
                     <div class="w-20 h-20 bg-gray-100 rounded-full mx-auto mb-3 flex items-center justify-center text-2xl text-gray-400 font-bold" id="profileInitials">JT</div>
                     <h2 class="text-lg font-bold text-gray-800" id="profileName">User</h2>
                     <p class="text-xs text-gray-500 mb-1" id="profileEmail">email@example.com</p>
                     <p class="text-xs font-bold text-blue-600 mb-3" id="profileSalaryDisplay"></p>
                     <span class="inline-block bg-gray-100 text-gray-600 text-[10px] px-3 py-1 rounded-full font-bold">Joined: <span id="profileJoined">-</span></span>
                </div>
                
                <div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
                    <div class="p-3 border-b border-gray-50 bg-gray-50/50"><h3 class="font-bold text-xs text-gray-600 uppercase">Financials</h3></div>
                    <div id="payoutHistoryList" class="p-4 space-y-2 text-xs text-gray-500"><p class="text-center italic">No records found.</p></div>
                </div>
            </div>

            <!-- ================= MODALS ================= -->

            <!-- Camera Modal -->
            <div id="cameraModal" class="fixed inset-0 bg-black z-[100] hidden flex flex-col">
                <div class="relative flex-grow bg-black">
                    <video id="videoElement" autoplay playsinline class="w-full h-full object-cover"></video>
                    <canvas id="canvasElement" class="hidden"></canvas>
                    <div class="absolute top-0 left-0 right-0 p-4 bg-gradient-to-b from-black/60 to-transparent text-white text-center text-sm font-bold">Face Verification Required</div>
                </div>
                <div class="h-32 bg-black flex items-center justify-center gap-8 pb-4">
                    <button id="closeCameraBtn" class="w-12 h-12 rounded-full bg-gray-800 text-white flex items-center justify-center"><i class="fas fa-times"></i></button>
                    <button id="captureBtn" class="w-20 h-20 rounded-full bg-white border-4 border-gray-400 active:scale-90 transition"></button>
                    <div class="w-12"></div>
                </div>
            </div>

            <!-- Edit Shift Modal -->
            <div id="editShiftModal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl w-full max-w-sm p-5">
                    <h3 class="font-bold text-gray-800 mb-4">Edit Session Time</h3>
                    <input type="hidden" id="editShiftId">
                    <div class="space-y-3">
                        <div>
                            <label class="text-[10px] uppercase font-bold text-gray-400">Check In Time</label>
                            <input type="datetime-local" id="editShiftIn" class="w-full p-2 border rounded text-sm">
                        </div>
                        <div>
                            <label class="text-[10px] uppercase font-bold text-gray-400">Check Out Time</label>
                            <input type="datetime-local" id="editShiftOut" class="w-full p-2 border rounded text-sm">
                        </div>
                        <div class="flex gap-2 pt-2">
                            <button onclick="document.getElementById('editShiftModal').classList.add('hidden')" class="flex-1 py-2 border rounded-lg text-sm">Cancel</button>
                            <button id="saveShiftTimeBtn" class="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold text-sm">Update</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Create User Modal -->
            <div id="createUserModal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl w-full max-w-md overflow-hidden max-h-[90vh] overflow-y-auto">
                    <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <h3 class="font-bold text-sm text-gray-700">Add New Staff</h3>
                        <button onclick="document.getElementById('createUserModal').classList.add('hidden')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
                    </div>
                    <form id="createUserForm" class="p-5 space-y-4">
                        <input type="text" id="newUserName" class="w-full p-3 border rounded-lg text-sm" placeholder="Full Name" required>
                        <input type="email" id="newUserEmail" class="w-full p-3 border rounded-lg text-sm" placeholder="Email" required>
                        <input type="password" id="newUserPassword" class="w-full p-3 border rounded-lg text-sm" placeholder="Password (min 6 chars)" required>
                        <div class="grid grid-cols-2 gap-3">
                            <select id="newUserRole" class="w-full p-3 border rounded-lg text-sm bg-white" onchange="toggleSalaryField()">
                                <option value="member">Squad Member</option>
                                <option value="fulltime">Full Time Staff</option>
                                <option value="manager">Manager</option>
                                <option value="admin">Admin</option>
                            </select>
                            <input type="number" id="newUserSalary" class="w-full p-3 border rounded-lg text-sm hidden" placeholder="Monthly Salary (₹)">
                        </div>
                        <div id="squadRateOverride" class="text-xs text-gray-500 bg-gray-50 p-2 rounded">
                            Standard Rate: ₹<span id="displayStdRate">30</span>/hr. Can edit in profile later.
                        </div>
                        <button type="submit" class="w-full py-3 bg-gray-900 text-white rounded-xl font-bold text-sm">Create Account</button>
                    </form>
                </div>
            </div>

            <!-- Edit User Modal -->
            <div id="editUserModal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl w-full max-w-sm overflow-hidden">
                    <div class="p-4 border-b border-gray-100 bg-gray-50"><h3 class="font-bold text-sm text-gray-700">Edit Staff Details</h3></div>
                    <div class="p-5 space-y-3">
                        <input type="hidden" id="editUserId">
                        <div class="space-y-1">
                            <label class="text-[10px] uppercase font-bold text-gray-400">Name</label>
                            <input type="text" id="editUserName" class="w-full border p-2 rounded text-sm">
                        </div>
                        
                        <!-- Salary Field -->
                        <div id="editSalaryField" class="space-y-1 hidden">
                            <label class="text-[10px] uppercase font-bold text-gray-400">Salary (₹)</label>
                            <input type="number" id="editUserSalary" class="w-full border p-2 rounded text-sm">
                        </div>
                        
                        <!-- Squad Fields -->
                        <div id="squadFields" class="grid grid-cols-2 gap-3 pt-2 border-t border-gray-100">
                             <div><label class="text-[10px] font-bold text-gray-400">Rate (₹/hr)</label><input type="number" id="editUserRate" class="w-full border p-2 rounded text-sm bg-yellow-50"></div>
                             <div><label class="text-[10px] font-bold text-gray-400">Bonus (Pts/hr)</label><input type="number" id="editUserBonusRate" class="w-full border p-2 rounded text-sm bg-yellow-50"></div>
                            
                            <div><label class="text-[10px] font-bold text-gray-400">Wallet (₹)</label><input type="number" id="editUserWallet" class="w-full border p-2 rounded text-sm"></div>
                            <div><label class="text-[10px] font-bold text-gray-400">Bonus Bal</label><input type="number" id="editUserBonus" class="w-full border p-2 rounded text-sm"></div>
                            <div><label class="text-[10px] font-bold text-red-400">Blocked (₹)</label><input type="number" id="editUserBlocked" class="w-full border p-2 rounded text-sm bg-red-50"></div>
                            <div><label class="text-[10px] font-bold text-red-400">Strikes</label><input type="number" id="editUserStrikes" class="w-full border p-2 rounded text-sm bg-red-50"></div>
                        </div>
                        
                        <div class="flex gap-2 mt-4 pt-2">
                             <button id="addStrikeBtn" class="hidden flex-1 py-2 bg-red-100 text-red-700 rounded-lg text-xs font-bold">+1 Strike</button>
                            <button id="saveUserChangesBtn" class="flex-[2] py-2 bg-blue-600 text-white rounded-lg text-xs font-bold">Save Changes</button>
                        </div>
                        <button onclick="document.getElementById('editUserModal').classList.add('hidden')" class="w-full mt-2 text-xs text-gray-400">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Payout Modal -->
            <div id="payoutModal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl w-full max-w-sm p-6">
                    <h3 class="text-lg font-bold mb-1">Process Payment</h3>
                    <p class="text-xs text-gray-500 mb-4" id="payoutSubtitle">Record transaction</p>
                    <form id="payoutForm" class="space-y-4">
                        <input type="hidden" id="payoutUid">
                        <input type="hidden" id="payoutMax"> <!-- -1 for unlimited/salary -->
                        <input type="number" id="payoutAmount" class="w-full p-3 border rounded-lg text-lg font-bold text-center" placeholder="₹0.00" required>
                        <div class="flex gap-2">
                            <button type="button" onclick="document.getElementById('payoutModal').classList.add('hidden')" class="flex-1 py-3 border rounded-xl font-bold">Cancel</button>
                            <button type="submit" class="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold">Confirm</button>
                        </div>
                    </form>
                </div>
            </div>
<!-- Client Recharge Modal -->
<div id="rechargeModal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-sm p-6">
        <h3 class="text-lg font-bold mb-1">Recharge Client Wallet</h3>
        <p class="text-xs text-gray-500 mb-4">10% Service Charge will be deducted.</p>
        <input type="hidden" id="rechargeUid">
        <input type="number" id="rechargeAmount" class="w-full p-3 border rounded-lg text-lg font-bold text-center mb-4" placeholder="Amount (₹)" required>
        <div class="flex justify-between text-xs text-gray-500 mb-4 px-2">
            <span>Service Fee (10%): <span id="displayFee" class="font-bold">₹0</span></span>
            <span>Net Credit: <span id="displayNet" class="font-bold text-green-600">₹0</span></span>
        </div>
        <div class="flex gap-2">
            <button onclick="document.getElementById('rechargeModal').classList.add('hidden')" class="flex-1 py-3 border rounded-xl font-bold">Cancel</button>
            <button onclick="window.confirmRecharge()" class="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold">Recharge</button>
        </div>
    </div>
</div>
            <!-- Redeem Modal -->
            <div id="redeemModal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl w-full max-w-sm p-6">
                    <h3 class="text-lg font-bold mb-4">Redeem Food Points</h3>
                    <form id="redeemForm" class="space-y-3">
                        <select id="redeemUserSelect" class="w-full p-3 border rounded-lg text-sm bg-gray-50" required></select>
                        <input type="number" id="redeemAmount" class="w-full p-3 border rounded-lg text-sm" placeholder="Points to Redeem" required>
                        <input type="text" id="redeemDesc" class="w-full p-3 border rounded-lg text-sm" placeholder="Description (e.g. Sandwich)" required>
                        <div class="flex gap-2 pt-2">
                            <button type="button" onclick="document.getElementById('redeemModal').classList.add('hidden')" class="flex-1 py-3 border rounded-xl font-bold text-sm">Cancel</button>
                            <button type="submit" class="flex-1 py-3 bg-orange-600 text-white rounded-xl font-bold text-sm">Redeem</button>
                        </div>
                    </form>
                </div>
            </div>
<!-- Create Client Modal -->
<div id="createClientModal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-md overflow-y-auto max-h-[90vh]">
        <div class="p-4 border-b flex justify-between"><h3 class="font-bold text-sm">Register Client</h3><button onclick="document.getElementById('createClientModal').classList.add('hidden')"><i class="fas fa-times"></i></button></div>
        <form id="createClientForm" class="p-5 space-y-3">
            <input type="text" id="cliName" class="w-full p-2 border rounded text-sm" placeholder="Restaurant Name" required>
            <input type="text" id="cliPhone" class="w-full p-2 border rounded text-sm" placeholder="Phone" required>
            <input type="text" id="cliAddress" class="w-full p-2 border rounded text-sm" placeholder="Address" required>
            <div class="flex gap-2">
                <input type="number" step="any" id="cliLat" class="w-1/2 p-2 border rounded text-sm" placeholder="Latitude" required>
                <input type="number" step="any" id="cliLng" class="w-1/2 p-2 border rounded text-sm" placeholder="Longitude" required>
            </div>
            <p onclick="navigator.geolocation.getCurrentPosition(p=>{document.getElementById('cliLat').value=p.coords.latitude;document.getElementById('cliLng').value=p.coords.longitude})" class="text-[10px] text-blue-600 underline cursor-pointer">Use Current Location</p>
            <input type="email" id="cliEmail" class="w-full p-2 border rounded text-sm" placeholder="Login Email" required>
            <input type="password" id="cliPass" class="w-full p-2 border rounded text-sm" placeholder="Login Password" required>
            <button type="submit" class="w-full py-3 bg-gray-900 text-white rounded-xl font-bold text-sm">Register Client</button>
        </form>
    </div>
</div>

<!-- Assign Staff Modal -->
<div id="assignModal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-sm p-5">
        <h3 class="font-bold mb-3">Assign Squad Member</h3>
        <input type="hidden" id="assignReqId">
        <select id="assignStaffSelect" class="w-full p-3 border rounded mb-4 text-sm"></select>
        <button onclick="window.confirmAssignment()" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold">Assign</button>
    </div>
</div>

<!-- Manage Slot Modal (Admin/Manager) -->
<div id="manageSlotModal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-sm p-5">
        <h3 class="font-bold text-gray-800 mb-4">Manage Slot</h3>
        <input type="hidden" id="manageSlotId">
        
        <div class="space-y-3">
            <div>
                <label class="text-[10px] uppercase font-bold text-gray-400">Assigned Staff</label>
                <select id="manageSlotStaff" class="w-full p-2 border rounded text-sm bg-white"></select>
            </div>
            <div class="flex gap-2">
                <div class="w-1/2">
                    <label class="text-[10px] uppercase font-bold text-gray-400">Start Time</label>
                    <input type="time" id="manageSlotStart" class="w-full p-2 border rounded text-sm">
                </div>
                <div class="w-1/2">
                    <label class="text-[10px] uppercase font-bold text-gray-400">End Time</label>
                    <input type="time" id="manageSlotEnd" class="w-full p-2 border rounded text-sm">
                </div>
            </div>
            
            <div class="flex gap-2 pt-2">
                <button onclick="window.deleteSlotRequest()" class="flex-1 py-3 bg-red-50 text-red-600 rounded-xl font-bold text-sm border border-red-100">Delete</button>
                <button onclick="window.saveSlotChanges()" class="flex-[2] py-3 bg-blue-600 text-white rounded-xl font-bold text-sm">Save Changes</button>
            </div>
            <button onclick="document.getElementById('manageSlotModal').classList.add('hidden')" class="w-full text-center text-xs text-gray-400 mt-2">Cancel</button>
        </div>
    </div>
</div>
        </main>

        <!-- Bottom Navigation (Member/Personal) -->
        <nav class="bg-white shadow-[0_-4px_20px_rgba(0,0,0,0.05)] border-t border-gray-100 p-2 flex justify-around items-center z-40 hidden fixed bottom-0 w-full shrink-0" id="bottomNav">
            <button class="nav-btn active flex-1 flex flex-col items-center p-2 rounded-lg" onclick="switchMemberTab('dashboard')"><i class="fas fa-home text-xl mb-1"></i><span class="text-[10px] font-bold">Home</span></button>
            <button class="nav-btn flex-1 flex flex-col items-center p-2 rounded-lg" onclick="switchMemberTab('history')"><i class="fas fa-history text-xl mb-1"></i><span class="text-[10px] font-bold">History</span></button>
            <button class="nav-btn flex-1 flex flex-col items-center p-2 rounded-lg" onclick="switchMemberTab('profile')"><i class="fas fa-user text-xl mb-1"></i><span class="text-[10px] font-bold">Profile</span></button>
        </nav>
    </div>

    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, getDoc, getDocs, setDoc, updateDoc, onSnapshot, query, where, orderBy, limit, deleteDoc, serverTimestamp, runTransaction, Timestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // Config
        const firebaseConfig = { apiKey: "AIzaSyCtrDxf2S2Zp1hY1RMJQzLHb9TGnup4SLE", authDomain: "jt-squad-manager.firebaseapp.com", projectId: "jt-squad-manager", storageBucket: "jt-squad-manager.firebasestorage.app", messagingSenderId: "444609515858", appId: "1:444609515858:web:0e4d00cf14a107618bea8b" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const secondaryApp = initializeApp(firebaseConfig, "Secondary");
        const secondaryAuth = getAuth(secondaryApp);

        let APP_CONFIG = { hourlyRate: 30, bonusRate: 5, radius: 200, trainingDays: 30, outletLat: 13.024976, outletLng: 77.562472 };
        let currentUserData = null, workTimerInterval = null, currentShiftId = null, listeners = [];

        // --- AUTH & INIT ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('appLayout').classList.remove('hidden');
                await loadSettings();
                
                // Real-time Profile Listener
                listeners.push(onSnapshot(doc(db, "users", user.uid), (docSnap) => {
                    if (docSnap.exists()) {
                        currentUserData = { uid: user.uid, ...docSnap.data() };
                        checkAndUnlockTrainingFunds(currentUserData);
                        renderRouter();
                    } else {
                        signOut(auth);
                    }
                }));
            } else {
                listeners.forEach(u => u()); listeners = [];
                document.getElementById('authSection').classList.remove('hidden');
                document.getElementById('appLayout').classList.add('hidden');
                document.getElementById('bottomNav').classList.add('hidden');
            }
        });

        async function loadSettings() {
            try { const s = await getDoc(doc(db, "settings", "global")); if(s.exists()) APP_CONFIG = { ...APP_CONFIG, ...s.data() }; } catch(e){}
            document.getElementById('displayStdRate').innerText = APP_CONFIG.hourlyRate;
        }

        // --- AUTOMATION: Training Funds Unlock ---
        async function checkAndUnlockTrainingFunds(user) {
            if (user.role !== 'member' || user.blockedWallet <= 0) return;
            const joinDate = user.joinedAt.toDate();
            const daysDiff = Math.floor((new Date() - joinDate) / (1000 * 60 * 60 * 24));
            
            if (daysDiff >= APP_CONFIG.trainingDays) {
                const amount = user.blockedWallet;
                await updateDoc(doc(db, "users", user.uid), {
                    mainWallet: (user.mainWallet || 0) + amount,
                    blockedWallet: 0
                });
                showToast(`Training complete! ₹${amount} unlocked.`);
            }
        }

        // --- ROUTER ---
        function renderRouter() {
    const role = currentUserData.role;
    const views = ['adminView', 'managerView', 'memberDashboard', 'clientView']; // Added clientView
    const nav = document.getElementById('bottomNav');
    
    document.getElementById('headerRoleDisplay').innerText = role.toUpperCase();

    views.forEach(v => document.getElementById(v).classList.add('hidden'));
    nav.classList.add('hidden');

    if (role === 'admin') {
        document.getElementById('adminView').classList.remove('hidden');
        initAdmin();
    } else if (role === 'client') {
        document.getElementById('clientView').classList.remove('hidden');
        initClient();
    } else if (role === 'manager') {
        if (window.isMyZoneActive) {
            document.getElementById('memberDashboard').classList.remove('hidden');
            nav.classList.remove('hidden');
            initMember();
        } else {
            document.getElementById('managerView').classList.remove('hidden');
            initManager();
        }
    } else {
        document.getElementById('memberDashboard').classList.remove('hidden');
        nav.classList.remove('hidden');
        initMember();
    }
}

function initClient() {
    const uid = currentUserData.uid;
    document.getElementById('clientHeaderName').innerText = currentUserData.name;
    document.getElementById('clientWalletBalance').innerText = (currentUserData.walletBalance || 0).toFixed(2);

    // Live Active Staff at this outlet
    listeners.push(onSnapshot(query(collection(db, "shifts"), where("clientId", "==", uid), where("status", "==", "active")), (snap) => {
        const l = document.getElementById('clientLiveList'); l.innerHTML = '';
        document.getElementById('clientLiveCount').innerText = snap.size;
        if(snap.empty) l.innerHTML = '<p class="text-center text-xs text-gray-400 italic">No active staff.</p>';
        snap.forEach(d => {
            const s = d.data();
            const start = s.checkInTime.toDate();
            l.innerHTML += `<div class="bg-green-50 p-3 rounded-lg border border-green-100 flex justify-between"><span class="font-bold text-sm">${s.userName}</span><span class="text-xs text-green-700">In: ${start.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span></div>`;
        });
    }));

// Client Expense/Wallet History
// Client Expense/Wallet History
    listeners.push(onSnapshot(query(collection(db, "client_transactions"), where("clientId", "==", uid), orderBy("date", "desc"), limit(20)), (snap) => {
        // Reuse 'clientRequestList' or 'clientWorkHistory' container? 
        // Better: Let's reuse 'clientWorkHistory' container for now, OR add a new one.
        // Let's target the 'clientWorkHistory' div but change the title dynamically or add a new section.
        
        // OPTION: We will create a new list inside the existing "Completed Work History" box for now, 
        // effectively replacing it with "Transactions" or appending.
        // BETTER: Let's find the div with id="clientWorkHistory" and use that to show transactions instead of just work hours.
        
        const l = document.getElementById('clientWorkHistory'); 
        l.innerHTML = '';
        if(snap.empty) l.innerHTML = '<p class="text-center text-xs text-gray-400 italic">No transactions.</p>';
        
        snap.forEach(d => {
            const t = d.data();
            const isCredit = t.type === 'recharge';
            const color = isCredit ? 'green' : 'red';
            const sign = isCredit ? '+' : '-';
            
            l.innerHTML += `
                <div class="flex justify-between items-center text-sm border-b border-gray-100 pb-2">
                    <div>
                        <div class="font-bold text-gray-700">${t.details || 'Transaction'}</div>
                        <div class="text-[10px] text-gray-400">${t.date?.toDate().toLocaleDateString()}</div>
                    </div>
                    <div class="font-bold text-${color}-600">${sign}₹${t.amount}</div>
                </div>`;
        });
    }));
    // Request History
    listeners.push(onSnapshot(query(collection(db, "shift_requests"), where("clientId", "==", uid)), (snap) => {
        const l = document.getElementById('clientRequestList'); l.innerHTML = '';
        snap.forEach(d => {
            const r = d.data();
            let statusBadge = r.status;
            if(r.status === 'assigned') statusBadge = 'Waiting Acceptance';
            const color = r.status === 'approved' ? 'green' : (r.status === 'pending' ? 'yellow' : 'gray');
            l.innerHTML += `<div class="flex justify-between items-center text-sm border-b border-gray-100 pb-2">
                <div><div class="font-bold">${r.date}</div><div class="text-xs text-gray-500">${r.startTime}-${r.endTime}</div></div>
                <div class="text-right"><div class="text-[10px] bg-${color}-100 text-${color}-800 px-2 rounded font-bold uppercase">${statusBadge}</div><div class="text-xs font-bold text-blue-600">${r.assignedName || 'Unassigned'}</div></div>
            </div>`;
        });
    }));
    
    // Work History
    listeners.push(onSnapshot(query(collection(db, "shifts"), where("clientId", "==", uid), where("status", "==", "completed"), orderBy("checkOutTime", "desc"), limit(10)), (snap) => {
        const l = document.getElementById('clientWorkHistory'); l.innerHTML = '';
        snap.forEach(d => {
            const s = d.data();
            l.innerHTML += `<div class="flex justify-between text-sm border-b border-gray-100 pb-2"><span>${s.checkInTime.toDate().toLocaleDateString()} - ${s.userName}</span><span class="font-bold">${s.hoursWorked.toFixed(2)} hrs</span></div>`;
        });
    }));

// Upcoming Approved Service Slots for Client
listeners.push(onSnapshot(query(collection(db, "shift_requests"), where("clientId", "==", uid), where("status", "==", "approved")), (snap) => {
    // You need a container in HTML for this. Let's assume you add one or reuse 'clientRequestList'
    // Ideally, add a new box <div id="clientUpcomingList"> in HTML first (Instruction B below)
    const l = document.getElementById('clientUpcomingList');
    if (l) {
        l.innerHTML = '';
        const todayStr = new Date().toISOString().split('T')[0];
        let count = 0;

        snap.forEach(d => {
            const r = d.data();
            if (r.date >= todayStr) {
                count++;
                l.innerHTML += `<div class="flex justify-between items-center border-b border-blue-100 py-2">
                    <div><span class="font-bold text-sm text-blue-900">${r.date}</span><div class="text-xs text-blue-600">${r.assignedName}</div></div>
                    <span class="font-mono text-xs font-bold text-blue-700">${r.startTime}-${r.endTime}</span>
                </div>`;
            }
        });
        if(count === 0) l.innerHTML = '<p class="text-center text-xs text-gray-400 italic">No upcoming services.</p>';
    }
}));
}

        // --- ADMIN CONTROLLER ---
        function initAdmin() {
            
            // 1. Staff List & Stats
            listeners.push(onSnapshot(query(collection(db, "users")), (snap) => {
                const tbody = document.getElementById('userTableBody'); tbody.innerHTML = '';
                let totSquad = 0, liab = 0;
                
                snap.forEach(d => {
                    const u = d.data();
                    const isSquad = u.role === 'member';
                    if(isSquad) { totSquad++; liab += (u.mainWallet||0); }

                    const funds = isSquad ? 
                        `<div><span class="font-bold">₹${(u.mainWallet||0).toFixed(0)}</span> <span class="text-xs text-orange-500">(${u.bonusWallet||0}p)</span></div><div class="text-[10px] text-red-400">Locked: ₹${u.blockedWallet||0}</div>` : 
                        `<div class="text-xs text-gray-500">Salary: ₹${u.salary||0}</div>`;
                    
                    const perf = isSquad ? 
                        `<span class="text-red-500 font-bold text-xs">${u.strikes||0} Strikes</span>` :
                        `<span class="text-xs text-blue-600 font-bold">Leaves: ${u.leavesTaken||0}</span>`;

                    const tr = document.createElement('tr'); tr.className="border-b hover:bg-gray-50 search-item";
                    tr.dataset.search = u.name.toLowerCase();
                    tr.innerHTML = `
                        <td class="p-3"><div class="font-bold">${u.name}</div><span class="text-[10px] uppercase font-bold text-gray-400">${u.role}</span></td>
                        <td class="p-3 text-sm">${funds}</td>
                        <td class="p-3 text-sm">${perf}</td>
                        <td class="p-3 text-right flex gap-1 justify-end">
                            <button onclick="window.promptPay('${d.id}', ${u.mainWallet||0}, ${!isSquad})" class="bg-green-50 text-green-600 p-2 rounded hover:bg-green-100"><i class="fas fa-money-bill-wave"></i></button>
                            <button onclick="window.editUser('${d.id}')" class="bg-blue-50 text-blue-600 p-2 rounded hover:bg-blue-100"><i class="fas fa-edit"></i></button>
                            <button onclick="window.deleteUser('${d.id}')" class="bg-red-50 text-red-600 p-2 rounded hover:bg-red-100"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                
                document.getElementById('adminTotalSquad').innerText = totSquad; 
                document.getElementById('adminPendingPayout').innerText = liab.toFixed(0);
            }));

            // 2. Shifts (Recent)
            listeners.push(onSnapshot(query(collection(db, "shifts"), orderBy("checkInTime", "desc"), limit(20)), (snap) => {
                const b = document.getElementById('shiftTableBody'); b.innerHTML='';
                let active = 0;
                snap.forEach(d => {
                    const s = d.data();
                    if(s.status === 'active') active++;
                    const dur = s.status==='active' ? 'Active' : `${(s.hoursWorked||0).toFixed(2)} hrs`;
                    const tr = document.createElement('tr'); tr.className="border-b";
                    tr.innerHTML = `
                        <td class="p-3 text-xs">${s.checkInTime?.toDate().toLocaleDateString()}</td>
                        <td class="p-3 font-bold">${s.userName}</td>
                        <td class="p-3 text-xs text-gray-500">${dur}</td>
                        <td class="p-3 text-right flex justify-end gap-2">
                             <button onclick="window.openEditShiftModal('${d.id}')" class="text-blue-500 text-xs font-bold border px-1 rounded">Edit</button>
                            <button onclick="window.delShift('${d.id}')" class="text-red-400"><i class="fas fa-trash"></i></button>
                        </td>`;
                    b.appendChild(tr);
                });
                document.getElementById('adminActiveStaff').innerText = active;
            }));

            // 3. Pending Leaves
            listeners.push(onSnapshot(query(collection(db, "shift_requests"), where("type", "==", "leave"), where("status", "==", "pending")), (snap) => {
                const l = document.getElementById('adminLeaveList'); l.innerHTML = '';
                if(snap.empty) l.innerHTML = '<p class="text-center text-gray-400 text-xs italic">No pending leave requests.</p>';
                snap.forEach(d => {
                    const r = d.data();
                    const el = document.createElement('div'); el.className="bg-red-50 p-3 rounded-lg flex justify-between items-center border border-red-100";
                    el.innerHTML = `<div><p class="font-bold text-sm">${r.userName} <span class="text-[10px] bg-red-200 text-red-800 px-1 rounded">LEAVE</span></p><p class="text-xs text-gray-600">${r.date}</p><p class="text-[10px] italic text-gray-500">"${r.reason||'No reason'}"</p></div><div class="flex gap-2"><button onclick="window.handleReq('${d.id}','approved')" class="text-green-600 bg-white border px-2 py-1 rounded text-xs font-bold">Approve</button><button onclick="window.handleReq('${d.id}','rejected')" class="text-red-600 bg-white border px-2 py-1 rounded text-xs font-bold">Reject</button></div>`;
                    l.appendChild(el);
                });
            }));

            // 4. Upcoming Approved Leaves (New Feature)
            const todayStr = new Date().toISOString().split('T')[0];
            listeners.push(onSnapshot(query(collection(db, "shift_requests"), where("type", "==", "leave"), where("status", "==", "approved"), where("date", ">=", todayStr)), (snap) => {
                const l = document.getElementById('adminUpcomingLeaveList'); l.innerHTML = '';
                if(snap.empty) l.innerHTML = '<p class="text-center text-gray-400 text-xs italic">No upcoming leaves.</p>';
                snap.forEach(d => {
                    const r = d.data();
                    const el = document.createElement('div'); el.className="bg-green-50 p-3 rounded-lg flex justify-between items-center border border-green-100";
                    el.innerHTML = `<div><p class="font-bold text-sm">${r.userName}</p><p class="text-xs text-gray-600">${r.date}</p></div><div class="text-[10px] text-green-700 font-bold bg-white px-2 py-1 rounded">Approved</div>`;
                    l.appendChild(el);
                });
            }));
            
            // 5. Squad Schedule (Today & Tomorrow) (New Feature)
            loadSharedSchedule('adminScheduleList');

            // Init Settings
            document.getElementById('settingRate').value = APP_CONFIG.hourlyRate;
            document.getElementById('settingBonus').value = APP_CONFIG.bonusRate;
            document.getElementById('settingRadius').value = APP_CONFIG.radius;
            document.getElementById('settingTraining').value = APP_CONFIG.trainingDays;
            document.getElementById('settingLat').value = APP_CONFIG.outletLat;
            document.getElementById('settingLng').value = APP_CONFIG.outletLng;

// NEW: Admin Listener for Pending Squad Requests
listeners.push(onSnapshot(query(collection(db, "shift_requests"), where("type", "==", "shift"), where("status", "==", "pending")), (snap) => {
    const l = document.getElementById('adminSquadRequestList'); 
    l.innerHTML = '';
    if(snap.empty) l.innerHTML = '<p class="text-center text-gray-400 text-xs italic">No pending squad requests.</p>';
    
    snap.forEach(d => {
        const r = d.data();
        const el = document.createElement('div'); 
        el.className="bg-blue-50 p-3 rounded-lg flex justify-between items-center border border-blue-100";
        el.innerHTML = `
            <div>
                <p class="font-bold text-sm">${r.userName}</p>
                <p class="text-xs text-blue-600">${r.date} | ${r.startTime}-${r.endTime}</p>
            </div>
            <div class="flex gap-2">
                <button onclick="window.handleReq('${d.id}','approved')" class="text-green-500 hover:bg-green-100 p-1 rounded"><i class="fas fa-check"></i></button>
                <button onclick="window.handleReq('${d.id}','rejected')" class="text-red-500 hover:bg-red-100 p-1 rounded"><i class="fas fa-times"></i></button>
            </div>`;
        l.appendChild(el);
    });
}));

// Admin: Client List
listeners.push(onSnapshot(query(collection(db, "users"), where("role", "==", "client")), (snap) => {
    const l = document.getElementById('clientTableBody'); l.innerHTML = '';
    snap.forEach(d => {
        const u = d.data();
        // REPLACE THE HTML GENERATION PART IN THE LOOP:
    const tr = document.createElement('tr'); tr.className = "border-b hover:bg-gray-50";
    tr.innerHTML = `
        <td class="p-3"><div class="font-bold">${u.name}</div><div class="text-[10px] text-gray-400">${u.phone}</div></td>
        <td class="p-3 text-xs">${u.address}</td>
        <td class="p-3"><div class="text-xs font-bold text-green-600">₹${(u.walletBalance||0).toFixed(0)}</div></td>
        <td class="p-3 text-right">
            <button onclick="window.openRechargeModal('${d.id}')" class="bg-blue-50 text-blue-600 p-2 rounded hover:bg-blue-100 text-xs font-bold">Recharge</button>
<button onclick="window.viewClientHistory('${d.id}')" class="bg-gray-100 text-gray-600 p-2 rounded hover:bg-gray-200 text-xs font-bold ml-1">History</button>
            <button onclick="window.deleteUser('${d.id}')" class="text-red-400 ml-2"><i class="fas fa-trash"></i></button>
        </td>`;
    l.appendChild(tr);
    });
}));

// Admin: Total Fees Collected
listeners.push(onSnapshot(query(collection(db, "client_transactions"), where("type", "==", "service_fee")), (snap) => {
    let total = 0;
    snap.forEach(d => total += d.data().amount);
    document.getElementById('adminFeesCollected').innerText = total.toFixed(0);
}));

// Admin: View Service Requests (Manager/Admin view)
// Admin: View Service Requests & Assign Staff
listeners.push(onSnapshot(query(collection(db, "shift_requests"), where("type", "==", "service"), where("status", "==", "pending")), (snap) => {
    const l = document.getElementById('adminServiceReqList'); 
    l.innerHTML = '';
    
    if(snap.empty) {
        l.innerHTML = '<p class="text-center text-gray-400 text-xs italic">No pending service requests.</p>';
        return;
    }

    snap.forEach(d => {
        const r = d.data();
        const el = document.createElement('div'); 
        el.className="bg-purple-50 p-3 rounded-lg flex justify-between items-center border border-purple-200 mb-2";
        el.innerHTML = `
            <div>
                <p class="font-bold text-sm text-purple-900">${r.clientName}</p>
                <p class="text-xs text-purple-600">${r.date} | ${r.startTime}-${r.endTime}</p>
            </div>
            <button onclick="window.openAssignModal('${d.id}')" class="bg-purple-600 text-white px-3 py-1 rounded text-xs font-bold shadow hover:bg-purple-700 transition">Assign Staff</button>
        `;
        l.appendChild(el);
    });
}));
        }

        // Shared Logic for Admin and Manager Schedule
        function loadSharedSchedule(elementId) {
     const today = new Date();
     const todayStr = today.toISOString().split('T')[0];
     const tmrw = new Date(); tmrw.setDate(tmrw.getDate()+1);
     const tmrwStr = tmrw.toISOString().split('T')[0];

     // REMOVE "type" filter to show both Shifts and Services
     listeners.push(onSnapshot(query(collection(db, "shift_requests"), where("status", "==", "approved")), (snap) => {
        const l = document.getElementById(elementId); 
        if(!l) return;
        l.innerHTML = '';
        
        let events = [];
       snap.forEach(d => events.push({ id: d.id, ...d.data() }));
        
        // Filter only today and tomorrow and sort
        events = events.filter(e => e.date === todayStr || e.date === tmrwStr);
        events.sort((a,b) => (a.date > b.date) ? 1 : (a.date === b.date ? (a.startTime > b.startTime ? 1 : -1) : -1));

        if(events.length === 0) { l.innerHTML = '<p class="text-center text-xs text-gray-400 italic">No approved slots for today or tomorrow.</p>'; return; }

        events.forEach(r => {
            // Check if the event date is today or in the future
            if(r.date >= todayStr) {
                const isToday = r.date === todayStr;
                const colorClass = isToday ? "bg-blue-50 border-blue-100" : "bg-gray-50 border-gray-100";
                const badge = isToday ? '<span class="text-[10px] bg-blue-200 text-blue-800 px-1 rounded font-bold ml-1">TODAY</span>' : '<span class="text-[10px] bg-gray-200 text-gray-800 px-1 rounded font-bold">TOMORROW</span>';
                
                // Determine Title and Subtitle based on Request Type ('service' vs 'shift')
                const title = r.type === 'service' ? 
                    `<span class="text-purple-700 font-bold">${r.clientName} (Service)</span>` : 
                    r.userName; 

                const sub = r.type === 'service' ? 
                    `<span class="text-[10px] text-gray-500">Assigned: ${r.assignedName || 'Pending'}</span>` : 
                    `<span class="text-[10px] text-gray-500">Regular Shift</span>`;

                const el = document.createElement('div'); 
                el.className = `flex justify-between items-center p-3 rounded-lg border ${colorClass} mb-2`;
                el.innerHTML = `
                    <div class="flex-grow">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-bold text-xs text-gray-500">${r.date}</span>
                            ${badge}
                        </div>
                        <div class="text-sm">${title}</div>
                        ${sub}
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-mono font-bold text-gray-600 bg-white px-2 py-1 rounded border mb-1">${r.startTime} - ${r.endTime}</div>
                        <!-- EDIT BUTTON ADDED HERE -->
                        <button onclick="window.openManageSlot('${r.id}')" class="text-[10px] text-blue-600 font-bold underline">Edit</button>
                    </div>`;
                l.appendChild(el);
            }
        });
     }));
}

        // --- MANAGER CONTROLLER ---
        function initManager() {
            const today = new Date(); document.getElementById('mgrDateDisplay').innerText = today.toDateString();
            
            // Live View
            listeners.push(onSnapshot(query(collection(db, "shifts"), where("status", "==", "active")), (snap) => {
                const l = document.getElementById('liveWorkersList'); l.innerHTML = '';
                let count = 0;
                snap.forEach(d => {
                    const s = d.data();
                    count++;
                    const start = s.checkInTime.toDate();
                    const el = document.createElement('div'); el.className="flex justify-between items-center bg-green-50 p-3 rounded-lg border border-green-100";
                    el.innerHTML = `<div><p class="font-bold text-sm">${s.userName}</p><p class="text-[10px] text-green-700 font-mono">In: ${start.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</p></div><button onclick="window.forceStop('${d.id}')" class="text-xs bg-white border border-red-200 text-red-500 px-2 py-1 rounded hover:bg-red-50">End Session</button>`;
                    l.appendChild(el);
                });
                document.getElementById('mgrLiveCount').innerText = count + " Active";
                if(count === 0) l.innerHTML = '<p class="text-center text-gray-400 text-xs italic py-4">Floor Clear</p>';
            }));

            // Slot Requests (Squad Only)
            listeners.push(onSnapshot(query(collection(db, "shift_requests"), where("type", "==", "shift"), where("status", "==", "pending")), (snap) => {
                const l = document.getElementById('slotRequestsList'); l.innerHTML = '';
                if(snap.empty) l.innerHTML = '<p class="text-center text-gray-400 text-xs italic">No pending requests.</p>';
                snap.forEach(d => {
                    const r = d.data();
                    const el = document.createElement('div'); el.className="bg-blue-50 p-3 rounded-lg flex justify-between items-center border border-blue-100";
                    el.innerHTML = `<div><p class="font-bold text-sm">${r.userName}</p><p class="text-xs text-blue-600">${r.date} | ${r.startTime}-${r.endTime}</p></div><div class="flex gap-2"><button onclick="window.handleReq('${d.id}','approved')" class="text-green-500 hover:bg-green-100 p-1 rounded"><i class="fas fa-check"></i></button><button onclick="window.handleReq('${d.id}','rejected')" class="text-red-500 hover:bg-red-100 p-1 rounded"><i class="fas fa-times"></i></button></div>`;
                    l.appendChild(el);
                });
            }));

            // Manager Schedule View (New Feature)
            loadSharedSchedule('mgrScheduleList');

// Manager: Service Requests (Client needs staff)
listeners.push(onSnapshot(query(collection(db, "shift_requests"), where("type", "==", "service"), where("status", "==", "pending")), (snap) => {
    // You need to add a container <div id="serviceReqList"> in Manager View HTML if not there.
    // For this guide, I assume you will add a container or reuse 'slotRequestsList' with a distinction.
    const l = document.getElementById('slotRequestsList'); // Reusing list
    snap.forEach(d => {
        const r = d.data();
        const el = document.createElement('div'); el.className="bg-purple-50 p-3 rounded-lg flex justify-between items-center border border-purple-200 mb-2";
        el.innerHTML = `
            <div><p class="font-bold text-sm text-purple-900">${r.clientName} (Client)</p><p class="text-xs text-purple-600">${r.date} | ${r.startTime}-${r.endTime}</p></div>
            <button onclick="window.openAssignModal('${d.id}')" class="bg-purple-600 text-white px-3 py-1 rounded text-xs font-bold shadow">Assign</button>
        `;
        l.appendChild(el);
    });
}));
        }

        // --- MEMBER / PERSONAL CONTROLLER ---
        function initMember() {
            const d = currentUserData;
            const isSquad = d.role === 'member';
            
            // UI Customization based on Role
            document.getElementById('memberRoleBadge').innerText = isSquad ? "SQUAD MEMBER" : (d.role === 'manager' ? "MANAGER" : "FULL TIME");
            document.getElementById('mgrBackBtn').classList.toggle('hidden', d.role !== 'manager');
            document.getElementById('memberId').innerText = d.uid.substring(0,6).toUpperCase();
            document.getElementById('memberName').innerText = d.name;
            document.getElementById('memberInitials').innerText = d.name.substring(0,2).toUpperCase();
            document.getElementById('profileName').innerText = d.name;
            document.getElementById('profileEmail').innerText = d.email;
            document.getElementById('profileJoined').innerText = d.joinedAt?.toDate().toLocaleDateString() || '-';
            
            // Explicitly handle "Training Wallet" visibility
            const trainingAlert = document.getElementById('blockedFundsAlert');
            if(!isSquad) {
                trainingAlert.classList.add('hidden'); // Ensure hidden for FT
                document.getElementById('profileSalaryDisplay').innerText = `Salary: ₹${d.salary || 'Not Set'}`;
                document.getElementById('fullTimeFilter').classList.remove('hidden');
                document.getElementById('squadBookingUI').classList.add('hidden');
                document.getElementById('ftLeaveUI').classList.remove('hidden');
                document.getElementById('bookingTitle').innerText = "Request Leave";
                document.getElementById('memberUpcomingSlotsBox').classList.add('hidden'); // Hide slots for FT
            } else {
                // Check training days for Squad
                const days = Math.floor((new Date() - (d.joinedAt?.toDate()||new Date()))/(1000*60*60*24));
                if (days < APP_CONFIG.trainingDays) {
                    trainingAlert.classList.remove('hidden');
                    document.getElementById('memberBlockedWallet').innerText = (d.blockedWallet||0).toFixed(0);
                } else {
                    trainingAlert.classList.add('hidden');
                }

                document.getElementById('profileSalaryDisplay').innerText = '';
                document.getElementById('fullTimeFilter').classList.add('hidden');
                document.getElementById('squadBookingUI').classList.remove('hidden');
                document.getElementById('ftLeaveUI').classList.add('hidden');
                document.getElementById('bookingTitle').innerText = "Book Slot (Next Day)";
                document.getElementById('memberUpcomingSlotsBox').classList.remove('hidden');
            }

            // Stats Grid
            window.renderFullTimeStats(); 

            // Active Shift Monitor
            listeners.push(onSnapshot(query(collection(db, "shifts"), where("userId", "==", d.uid), where("status", "==", "active")), (snap) => {
                const inBtn = document.getElementById('checkInBtnArea');
                const outBtn = document.getElementById('checkOutBtnArea');
                
                if(!snap.empty) {
                    currentShiftId = snap.docs[0].id;
                    const start = snap.docs[0].data().checkInTime.toDate();
                    inBtn.classList.add('hidden');
                    outBtn.classList.remove('hidden');
                    
                    if(workTimerInterval) clearInterval(workTimerInterval);
                    workTimerInterval = setInterval(() => {
                        const diff = new Date() - start;
                        document.getElementById('workTimer').innerText = new Date(diff).toISOString().substr(11, 8);
                    }, 1000);
                } else {
                    currentShiftId = null;
                    inBtn.classList.remove('hidden');
                    outBtn.classList.add('hidden');
                    if(workTimerInterval) clearInterval(workTimerInterval);
                }
            }));

            // Upcoming Approved Slots Monitor (Squad Only) (New Feature)
            // Upcoming Approved Slots Monitor (Squad Only)
if(isSquad) {
    const todayStr = new Date().toISOString().split('T')[0];
    // Listen for BOTH direct user requests AND assigned services
    // Note: To simplify without complex OR queries, we rely on 'userId' being updated on assignment.
    listeners.push(onSnapshot(query(collection(db, "shift_requests"), where("userId", "==", d.uid), where("status", "==", "approved")), (snap) => {
        const l = document.getElementById('memberUpcomingList'); l.innerHTML = '';
        let count = 0;
        
        snap.forEach(doc => {
            const r = doc.data();
            if (r.date >= todayStr) {
                count++;
                // Show Client Name if it exists
                const clientInfo = r.clientName ? `<div class="text-[10px] text-purple-600 font-bold mt-0.5"><i class="fas fa-map-marker-alt mr-1"></i>${r.clientName}</div>` : '';
                
                l.innerHTML += `<div class="flex justify-between items-center border-b border-blue-100 py-2 last:border-0">
                    <div>
                        <span class="font-bold text-blue-900 text-sm">${r.date}</span>
                        ${clientInfo}
                    </div>
                    <span class="text-blue-700 text-xs font-bold bg-blue-50 px-2 py-1 rounded">${r.startTime} - ${r.endTime}</span>
                </div>`;
            }
        });

        if(count === 0) l.innerHTML = '<p class="text-center italic opacity-50 text-xs">No upcoming slots</p>';
    }));
}

            loadHistory();
            loadPayouts();
        }

        window.renderFullTimeStats = async () => {
            if (!currentUserData) return;
            const isSquad = currentUserData.role === 'member';
            const grid = document.getElementById('statsGrid');
            
            if (isSquad) {
                grid.innerHTML = `
                    <div class="text-center p-2 rounded-lg bg-gray-800/50"><p class="text-[10px] uppercase text-gray-400 mb-1">Wallet</p><p class="font-bold text-lg">₹${(currentUserData.mainWallet||0).toFixed(0)}</p></div>
                    <div class="text-center p-2 rounded-lg bg-gray-800/50"><p class="text-[10px] uppercase text-gray-400 mb-1">Points</p><p class="font-bold text-lg text-orange-400">${currentUserData.bonusWallet||0}</p></div>
                    <div class="text-center p-2 rounded-lg bg-gray-800/50"><p class="text-[10px] uppercase text-gray-400 mb-1">Strikes</p><p class="font-bold text-lg text-red-400">${currentUserData.strikes||0}</p></div>
                `;
            } else {
                const filter = document.getElementById('statsDateFilter').value;
                // Client-side filtering logic remains same...
                const q = query(collection(db, "shifts"), where("userId", "==", currentUserData.uid), where("status", "==", "completed"));
                const snap = await getDocs(q);
                let hours = 0, days = 0;
                const now = new Date();
                const currentMonth = now.getMonth();
                const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;

                snap.forEach(d => {
                    const s = d.data();
                    const date = s.checkInTime.toDate();
                    let include = false;
                    
                    if (filter === 'all_time') include = true;
                    else if (filter === 'this_month' && date.getMonth() === currentMonth) include = true;
                    else if (filter === 'last_month' && date.getMonth() === lastMonth) include = true;

                    if (include) {
                        hours += s.hoursWorked || 0;
                        days++;
                    }
                });

                grid.innerHTML = `
                    <div class="text-center p-2 rounded-lg bg-gray-800/50"><p class="text-[10px] uppercase text-gray-400 mb-1">Days</p><p class="font-bold text-lg">${days}</p></div>
                    <div class="text-center p-2 rounded-lg bg-gray-800/50"><p class="text-[10px] uppercase text-gray-400 mb-1">Leaves</p><p class="font-bold text-lg text-red-400">${currentUserData.leavesTaken||0}</p></div>
                    <div class="text-center p-2 rounded-lg bg-gray-800/50"><p class="text-[10px] uppercase text-gray-400 mb-1">Hours</p><p class="font-bold text-lg">${hours.toFixed(1)}</p></div>
                `;
            }

// Job Offers
if(currentUserData.role === 'member') {
    listeners.push(onSnapshot(query(collection(db, "shift_requests"), where("assignedTo", "==", currentUserData.uid), where("status", "==", "assigned")), (snap) => {
        const box = document.getElementById('memberJobOffers');
        const l = document.getElementById('memberOfferList'); l.innerHTML = '';
        if(snap.empty) { box.classList.add('hidden'); return; }
        box.classList.remove('hidden');
        snap.forEach(d => {
            const r = d.data();
            l.innerHTML += `<div class="bg-white p-2 rounded border flex justify-between items-center">
                <div class="text-xs">
                    <div class="font-bold">${r.clientName}</div>
                    <div>${r.date} @ ${r.startTime}</div>
                </div>
                <div class="flex gap-1">
                    <button onclick="window.respondJob('${d.id}', 'approved')" class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold">Accept</button>
                    <button onclick="window.respondJob('${d.id}', 'pending')" class="bg-red-100 text-red-700 px-2 py-1 rounded text-[10px] font-bold">Deny</button>
                </div>
            </div>`;
        });
    }));
}
        };

        async function loadHistory() {
            // FIX: Removed orderBy to avoid index errors, doing client-side sort
            const q = query(collection(db, "shifts"), where("userId", "==", currentUserData.uid), where("status", "==", "completed"), limit(50));
            const snap = await getDocs(q);
            const l = document.getElementById('historyList'); l.innerHTML = '';
            
            let shifts = [];
            snap.forEach(d => shifts.push(d.data()));
            shifts.sort((a,b) => b.checkInTime.seconds - a.checkInTime.seconds); // Sort Descending

            if(shifts.length === 0) { l.innerHTML = '<p class="text-center text-xs text-gray-400 italic mt-4">No work history found.</p>'; return; }

            shifts.forEach(s => {
                const start = s.checkInTime.toDate();
                const end = s.checkOutTime.toDate();
                const timeStr = `${start.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} - ${end.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
                const earn = currentUserData.role === 'member' ? `<span class="text-green-600 font-bold text-xs">₹${(s.earnings||0).toFixed(2)}</span>` : '';

                const el = document.createElement('div');
                el.className = "bg-white p-3 rounded-lg border border-gray-100 flex justify-between items-center";
                el.innerHTML = `
                    <div>
                        <div class="text-xs font-bold text-gray-700">${end.toLocaleDateString()}</div>
                        <div class="text-[10px] text-gray-400 font-mono mt-1">${timeStr}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-bold text-gray-600">${(s.hoursWorked||0).toFixed(2)}h</div>
                        ${earn}
                    </div>
                `;
                l.appendChild(el);
            });
        }

        async function loadPayouts() {
            // FIX: Removed orderBy for same reason
            const snap = await getDocs(query(collection(db, "payouts"), where("userId", "==", currentUserData.uid), limit(20)));
            const l = document.getElementById('payoutHistoryList'); 
            l.innerHTML = '';
            
            let payouts = [];
            snap.forEach(d => payouts.push(d.data()));
            payouts.sort((a,b) => b.date.seconds - a.date.seconds);

            if(payouts.length === 0) { l.innerHTML = '<p class="text-center italic text-gray-400">No records found.</p>'; return; }
            
            payouts.forEach(p => {
                l.innerHTML += `<div class="flex justify-between border-b border-gray-50 pb-2 mb-2"><span class="text-gray-600">${p.date.toDate().toLocaleDateString()}</span><span class="font-bold text-green-600">+₹${p.amount}</span></div>`;
            });
        }

        // --- GLOBAL ACTIONS ---
        window.switchAdminTab = (t, e) => {
            document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active')); e.currentTarget.classList.add('active');
            ['overview','users','shifts','requests','settings'].forEach(k => document.getElementById(`adminTab-${k}`).classList.add('hidden'));
            document.getElementById(`adminTab-${t}`).classList.remove('hidden');
        };

        window.switchMemberTab = (t) => {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); 
            event.currentTarget.classList.add('active');
            ['Dashboard','History','Profile'].forEach(k => document.getElementById('member'+k).classList.add('hidden'));
            document.getElementById('member'+t.charAt(0).toUpperCase()+t.slice(1)).classList.remove('hidden');
        };

        // Filter Staff
        window.filterStaffTable = () => {
            const term = document.getElementById('staffSearch').value.toLowerCase();
            document.querySelectorAll('.search-item').forEach(row => {
                row.classList.toggle('hidden', !row.dataset.search.includes(term));
            });
        };

        // Manager Zones
        window.enterMyZone = () => { window.isMyZoneActive = true; renderRouter(); };
        window.exitMyZone = () => { window.isMyZoneActive = false; renderRouter(); };

        // Toggle Salary Field
        window.toggleSalaryField = () => {
            const r = document.getElementById('newUserRole').value;
            const isFt = r === 'fulltime' || r === 'manager';
            document.getElementById('newUserSalary').classList.toggle('hidden', !isFt);
            document.getElementById('squadRateOverride').classList.toggle('hidden', isFt);
        };

        // Config Save Logic (Fixed)
        document.getElementById('saveSettingsBtn').onclick = async () => {
            try {
                const rate = Number(document.getElementById('settingRate').value);
                const bonus = Number(document.getElementById('settingBonus').value);
                const radius = Number(document.getElementById('settingRadius').value);
                const train = Number(document.getElementById('settingTraining').value);
                const lat = Number(document.getElementById('settingLat').value);
                const lng = Number(document.getElementById('settingLng').value);
                
                await setDoc(doc(db, "settings", "global"), { 
                    hourlyRate: rate, bonusRate: bonus, radius: radius, trainingDays: train, outletLat: lat, outletLng: lng 
                });
                
                APP_CONFIG = { ...APP_CONFIG, hourlyRate: rate, bonusRate: bonus, radius: radius, trainingDays: train, outletLat: lat, outletLng: lng };
                showToast("Configuration Saved");
            } catch(e) { alert("Save Failed: " + e); }
        };

        // Edit Shift Logic (New Feature)
        window.openEditShiftModal = async (id) => {
            const s = (await getDoc(doc(db, "shifts", id))).data();
            document.getElementById('editShiftId').value = id;
            
            // Format for datetime-local (YYYY-MM-DDTHH:MM)
            const toLocal = (ts) => {
                if(!ts) return "";
                const d = ts.toDate();
                d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
                return d.toISOString().slice(0,16);
            };

            document.getElementById('editShiftIn').value = toLocal(s.checkInTime);
            document.getElementById('editShiftOut').value = toLocal(s.checkOutTime);
            document.getElementById('editShiftModal').classList.remove('hidden');
        };

        document.getElementById('saveShiftTimeBtn').onclick = async () => {
            const id = document.getElementById('editShiftId').value;
            const inTimeStr = document.getElementById('editShiftIn').value;
            const outTimeStr = document.getElementById('editShiftOut').value;
            
            if(!inTimeStr) return alert("Check-in time is required");

            try {
                await runTransaction(db, async(t) => {
                    const sRef = doc(db, "shifts", id);
                    const s = (await t.get(sRef)).data();
                    
                    const newIn = new Date(inTimeStr);
                    const newOut = outTimeStr ? new Date(outTimeStr) : null;
                    
                    let updates = { checkInTime: Timestamp.fromDate(newIn) };
                    
                    // If check-out is set, calculate duration and possibly close shift
                    if (newOut) {
                         const msWorked = newOut - newIn;
                         const mins = msWorked / (1000 * 60);
                         const hours = mins / 60;
                         if (hours <= 0) throw "Invalid Duration";
                         
                         updates.checkOutTime = Timestamp.fromDate(newOut);
                         updates.hoursWorked = hours;
                         
                         // If it was active, now it's completed
                         if(s.status === 'active') updates.status = 'completed';
                    } else {
                        // If clearing checkout time (reopening shift)
                        if(s.checkOutTime) {
                             updates.checkOutTime = null;
                             updates.status = 'active';
                             updates.hoursWorked = 0; // Reset
                        }
                    }
                    t.update(sRef, updates);
                });
                showToast("Shift Updated");
                document.getElementById('editShiftModal').classList.add('hidden');
            } catch(e) { alert(e); }
        };

        // Payout Logic
        window.promptPay = (uid, bal, isFullTime) => {
            document.getElementById('payoutUid').value = uid;
            document.getElementById('payoutMax').value = isFullTime ? -1 : bal;
            document.getElementById('payoutSubtitle').innerText = isFullTime ? "Salary Payment Record" : `Deduct from Wallet (Max: ₹${bal})`;
            document.getElementById('payoutModal').classList.remove('hidden');
        };

        document.getElementById('payoutForm').onsubmit = async (e) => {
            e.preventDefault();
            const uid = document.getElementById('payoutUid').value;
            const max = Number(document.getElementById('payoutMax').value);
            const amt = Number(document.getElementById('payoutAmount').value);
            
            if(max !== -1 && amt > max) return showToast("Insufficient Wallet Balance");

            try {
                await runTransaction(db, async(t) => {
                    const userRef = doc(db, "users", uid);
                    const userDoc = await t.get(userRef);
                    if(max !== -1) {
                        const newBal = (userDoc.data().mainWallet || 0) - amt;
                        if(newBal < 0) throw "Balance changed";
                        t.update(userRef, { mainWallet: newBal });
                    }
                    const payRef = doc(collection(db, "payouts"));
                    t.set(payRef, { userId: uid, amount: amt, date: serverTimestamp(), by: currentUserData.name });
                });
                showToast("Payment Recorded Successfully");
                document.getElementById('payoutModal').classList.add('hidden'); e.target.reset();
            } catch(err) { alert(err); }
        };

        // Edit User
        window.editUser = async (uid) => {
            const u = (await getDoc(doc(db,"users",uid))).data();
            document.getElementById('editUserId').value = uid;
            document.getElementById('editUserName').value = u.name;
            
            // Show/Hide Fields
            const isSquad = u.role === 'member';
            const isFt = u.role === 'fulltime' || u.role === 'manager';

            document.getElementById('squadFields').classList.toggle('hidden', !isSquad);
            document.getElementById('editSalaryField').classList.toggle('hidden', !isFt);
            document.getElementById('addStrikeBtn').classList.toggle('hidden', !isSquad);
            
            if(isSquad) {
                document.getElementById('editUserRate').value = u.customRate || APP_CONFIG.hourlyRate;
                document.getElementById('editUserBonusRate').value = u.customBonus || APP_CONFIG.bonusRate;
                document.getElementById('editUserWallet').value = u.mainWallet||0;
                document.getElementById('editUserBonus').value = u.bonusWallet||0;
                document.getElementById('editUserBlocked').value = u.blockedWallet||0;
                document.getElementById('editUserStrikes').value = u.strikes||0;
            } else if (isFt) {
                document.getElementById('editUserSalary').value = u.salary || 0;
            }

            document.getElementById('editUserModal').classList.remove('hidden');
            
            // Add Strike Handler
            document.getElementById('addStrikeBtn').onclick = async () => {
                if(!confirm("Add 1 Strike to this user?")) return;
                await updateDoc(doc(db,"users",uid), { strikes: (u.strikes||0)+1 });
                document.getElementById('editUserStrikes').value = (u.strikes||0)+1;
                showToast("Strike Added");
            };
        };

        document.getElementById('saveUserChangesBtn').onclick = async () => {
            const uid = document.getElementById('editUserId').value;
            const u = (await getDoc(doc(db,"users",uid))).data();
            const updates = { name: document.getElementById('editUserName').value };
            
            if(u.role === 'member') {
                updates.customRate = Number(document.getElementById('editUserRate').value);
                updates.customBonus = Number(document.getElementById('editUserBonusRate').value);
                updates.mainWallet = Number(document.getElementById('editUserWallet').value);
                updates.bonusWallet = Number(document.getElementById('editUserBonus').value);
                updates.blockedWallet = Number(document.getElementById('editUserBlocked').value);
                updates.strikes = Number(document.getElementById('editUserStrikes').value);
            } else {
                updates.salary = Number(document.getElementById('editUserSalary').value);
            }
            await updateDoc(doc(db,"users",uid), updates);
            document.getElementById('editUserModal').classList.add('hidden');
            showToast("Profile Updated");
        };

        // Attendance Logic
        document.getElementById('checkInBtn').onclick = async () => {
    if(!navigator.geolocation) return alert("Geolocation Access Required");
    const btn = document.getElementById('checkInBtn'); btn.innerText = "Locating...";

    // Check for approved client job TODAY
    const todayStr = new Date().toISOString().split('T')[0];
    const nowTime = new Date().toTimeString().split(' ')[0].substring(0,5); // HH:MM

    // Find a slot that is approved, for me, today, and we are roughly within start time
    const q = query(collection(db, "shift_requests"), 
        where("assignedTo", "==", currentUserData.uid), 
        where("status", "==", "approved"), 
        where("date", "==", todayStr),
        where("type", "==", "service")
    );
    const jobs = await getDocs(q);
    let targetLat = APP_CONFIG.outletLat, targetLng = APP_CONFIG.outletLng;
    let jobDetails = null;

    if(!jobs.empty) {
        // Use the first valid job found
        const job = jobs.docs[0].data();
        // Fetch client details for coordinates
        const clientDoc = await getDoc(doc(db, "users", job.clientId));
        if(clientDoc.exists()) {
            const c = clientDoc.data();
            targetLat = c.lat; targetLng = c.lng;
            jobDetails = { clientId: job.clientId, clientName: c.name };
        }
    }

    navigator.geolocation.getCurrentPosition(pos => {
        const dist = getDist(pos.coords.latitude, pos.coords.longitude, targetLat, targetLng);
        if (dist*1000 <= APP_CONFIG.radius) {
            // ... (Existing Camera Logic) ...
            navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}}).then(stream => {
                const v = document.getElementById('videoElement'); v.srcObject = stream;
                document.getElementById('cameraModal').classList.remove('hidden');
                document.getElementById('captureBtn').onclick = async () => {
                    const c = document.getElementById('canvasElement'); c.width=v.videoWidth; c.height=v.videoHeight;
                    c.getContext('2d').drawImage(v,0,0);
                    const photo = c.toDataURL('image/jpeg', 0.4);
                    stream.getTracks().forEach(t=>t.stop());
                    document.getElementById('cameraModal').classList.add('hidden');

                    // Construct Shift Data
                    let shiftData = { 
                        userId: currentUserData.uid, 
                        userName: currentUserData.name, 
                        checkInTime: serverTimestamp(), 
                        status: 'active', 
                        photo: photo 
                    };
                    // Link Client if applicable
                    if(jobDetails) {
                        shiftData.clientId = jobDetails.clientId;
                        shiftData.clientName = jobDetails.clientName;
                    }

                    await addDoc(collection(db, "shifts"), shiftData);
                    showToast("Check In Successful!");
                };
                document.getElementById('closeCameraBtn').onclick = () => { stream.getTracks().forEach(t=>t.stop()); document.getElementById('cameraModal').classList.add('hidden'); btn.innerText="CHECK IN"; };
            }).catch(e => { alert("Camera Error: " + e); btn.innerText="CHECK IN"; });
            // ... (End Camera Logic) ...
        } else {
            btn.innerText="CHECK IN";
            document.getElementById('geoError').innerText = `You are ${(dist*1000).toFixed(0)}m away from ${jobDetails ? jobDetails.clientName : 'Base'}.`;
            document.getElementById('geoError').classList.remove('hidden');
        }
    }, err => { alert("GPS Error"); btn.innerText="CHECK IN"; }, {enableHighAccuracy: true});
};

        // Shift End Logic (Minute Calculation)
        window.forceStop = async (id) => {
            if(!confirm("End this shift?")) return;
            try {
                await runTransaction(db, async(t) => {
                    const sRef = doc(db, "shifts", id);
                    const s = (await t.get(sRef)).data();
                    const uRef = doc(db, "users", s.userId);
                    const u = (await t.get(uRef)).data();

                    const end = new Date();
                    const start = s.checkInTime.toDate();
                    
                    // Minute Calculation
                    const msWorked = end - start;
                    const minsWorked = msWorked / (1000 * 60);
                    const hoursWorked = minsWorked / 60;
                    
                    if (minsWorked < 1) throw "Shift too short (< 1 min)";

                    let updates = { totalHours: (u.totalHours||0) + hoursWorked, totalDays: (u.totalDays||0) + 1 };
                    let pay = 0;

                    if(u.role === 'member') {
                        // Use custom rate if set, else global
                        const rate = u.customRate || APP_CONFIG.hourlyRate;
                        const bonusRate = u.customBonus || APP_CONFIG.bonusRate;

                        // Pay per minute: (Rate / 60) * minutes
                        pay = (rate / 60) * minsWorked;
                        const pts = Math.floor(hoursWorked * bonusRate); // Points usually per full hour, or we can do fraction: (bonusRate/60)*mins
                        
                        // Training Check
                        const joinDate = u.joinedAt.toDate();
                        const daysSinceJoin = Math.floor((new Date() - joinDate) / (1000 * 60 * 60 * 24));
                        const isTraining = daysSinceJoin < APP_CONFIG.trainingDays;
                        
                        if(isTraining) updates.blockedWallet = (u.blockedWallet||0) + pay;
                        else updates.mainWallet = (u.mainWallet||0) + pay;
                        
                        updates.bonusWallet = (u.bonusWallet||0) + pts;
                    }
// REPLACE THIS BLOCK
if(s.clientId) {
    const clientRef = doc(db, "users", s.clientId);
    const cDoc = await t.get(clientRef);
    if(cDoc.exists()) {
        const bill = hoursWorked * 35; // Example rate: ₹35/hr charged to client
        // Deduct from Wallet
        t.update(clientRef, { walletBalance: (cDoc.data().walletBalance||0) - bill });
        
        // Log Transaction
        const transRef = doc(collection(db, "client_transactions"));
        t.set(transRef, { 
            clientId: s.clientId, 
            amount: bill, 
            type: 'service_deduction', 
            date: serverTimestamp(), 
            details: `Service: ${s.userName} (${hoursWorked.toFixed(2)}h)` 
        });
    }
}
                    t.update(sRef, { status: 'completed', checkOutTime: serverTimestamp(), hoursWorked: hoursWorked, earnings: pay });
                    t.update(uRef, updates);
                });
                showToast("Shift Ended");
            } catch(e) { alert(e); }
        };
        
        document.getElementById('checkOutBtn').onclick = () => window.forceStop(currentShiftId);

        // Booking Logic (Squad)
        document.getElementById('bookSlotBtn').onclick = async () => {
            const s = document.getElementById('bookStartTime').value;
            const e = document.getElementById('bookEndTime').value;
            if(!s || !e) return showToast("Select Timing");
            if((currentUserData.strikes||0) >= 3) return alert("Account blocked due to strikes.");

            const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate()+1);
            const dStr = tomorrow.toISOString().split('T')[0];

            await addDoc(collection(db,"shift_requests"), { 
                userId: currentUserData.uid, userName: currentUserData.name, 
                date: dStr, startTime: s, endTime: e, 
                status: 'pending', type: 'shift'
            });
            showToast("Slot Requested");
        };

        // Leave Request Logic (Full Time)
        document.getElementById('requestLeaveBtn').onclick = async () => {
            const date = document.getElementById('leaveDate').value;
            const reason = document.getElementById('leaveReason').value;
            if(!date) return showToast("Select Date");
            
            await addDoc(collection(db,"shift_requests"), { 
                userId: currentUserData.uid, userName: currentUserData.name, 
                date: date, reason: reason,
                status: 'pending', type: 'leave'
            });
            showToast("Leave Requested");
        };

        // Helpers
        function getDist(lat1,lon1,lat2,lon2) {
            const R=6371; const dLat=deg2rad(lat2-lat1); const dLon=deg2rad(lon2-lon1);
            const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(deg2rad(lat1))*Math.cos(deg2rad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
            return R * (2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
        }
        function deg2rad(d) { return d*(Math.PI/180); }
        function showToast(m) { const t=document.getElementById('toast'); document.getElementById('toastMsg').innerText=m; t.classList.remove('translate-x-full'); setTimeout(()=>t.classList.add('translate-x-full'),3000); }
        
        // --- ADMIN BASE ACTIONS ---
        document.getElementById('createUserForm').onsubmit = async (e) => {
            e.preventDefault();
            try {
                const cred = await createUserWithEmailAndPassword(secondaryAuth, document.getElementById('newUserEmail').value, document.getElementById('newUserPassword').value);
                const role = document.getElementById('newUserRole').value;
                const sal = document.getElementById('newUserSalary').value;
                
                await setDoc(doc(db,"users",cred.user.uid), { 
                    name: document.getElementById('newUserName').value, 
                    email: document.getElementById('newUserEmail').value, 
                    role: role,
                    salary: role==='member' ? 0 : Number(sal),
                    joinedAt: serverTimestamp(), 
                    mainWallet:0, bonusWallet:0, blockedWallet:0, strikes:0, rating:5, totalHours:0, totalDays:0, leavesTaken:0 
                });
                await signOut(secondaryAuth);
                document.getElementById('createUserModal').classList.add('hidden'); e.target.reset(); showToast("User Created");
            } catch(x) { alert(x.message); }
        };

        window.deleteUser = async (uid) => { if(confirm("Delete User Data?")) await deleteDoc(doc(db,"users",uid)); };
        window.delShift = async (id) => { if(confirm("Delete Record?")) await deleteDoc(doc(db,"shifts",id)); };
        
        // Handle Request (Approve/Reject)
        window.handleReq = async (id, st) => {
            const ref = doc(db,"shift_requests",id);
            const req = (await getDoc(ref)).data();
            
            if (st === 'approved') {
                await updateDoc(ref, { status: st });
                // If it's a leave request, update user's leave count
                if (req.type === 'leave') {
                    const uRef = doc(db, "users", req.userId);
                    const u = (await getDoc(uRef)).data();
                    await updateDoc(uRef, { leavesTaken: (u.leavesTaken||0) + 1 });
                }
            } else {
                await updateDoc(ref, { status: st }); // Just mark rejected, don't delete immediately so they see history
            }
            showToast("Updated"); 
        };

        window.openRedeemModal = async () => {
            const s = document.getElementById('redeemUserSelect'); s.innerHTML='<option value="">Select Staff</option>';
            const snap = await getDocs(query(collection(db,"users"), where("role","==","member")));
            snap.forEach(d => { const u=d.data(); const o=document.createElement('option'); o.value=d.id; o.innerText=`${u.name} (${u.bonusWallet||0}pts)`; s.appendChild(o); });
            document.getElementById('redeemModal').classList.remove('hidden');
        };

        document.getElementById('redeemForm').onsubmit = async (e) => {
            e.preventDefault();
            const uid = document.getElementById('redeemUserSelect').value;
            const pts = Number(document.getElementById('redeemAmount').value);
            const desc = document.getElementById('redeemDesc').value;
            
            try {
                await runTransaction(db, async(t) => {
                    const ref = doc(db, "users", uid);
                    const u = (await t.get(ref)).data();
                    if((u.bonusWallet||0) < pts) throw "Insufficient Points";
                    t.update(ref, { bonusWallet: u.bonusWallet - pts });
                });
                showToast("Redeemed!");
                document.getElementById('redeemModal').classList.add('hidden'); e.target.reset();
            } catch(err) { alert(err); }
        };


// --- CLIENT & ASSIGNMENT ACTIONS ---

// Create Client
document.getElementById('createClientForm').onsubmit = async (e) => {
    e.preventDefault();
    try {
        const em = document.getElementById('cliEmail').value;
        const ps = document.getElementById('cliPass').value;
        const cred = await createUserWithEmailAndPassword(secondaryAuth, em, ps);
        
        await setDoc(doc(db, "users", cred.user.uid), {
            name: document.getElementById('cliName').value,
            phone: document.getElementById('cliPhone').value,
            address: document.getElementById('cliAddress').value,
            lat: Number(document.getElementById('cliLat').value),
            lng: Number(document.getElementById('cliLng').value),
            email: em,
            role: 'client',
            dueAmount: 0,
            joinedAt: serverTimestamp()
        });
        await signOut(secondaryAuth);
        document.getElementById('createClientModal').classList.add('hidden'); e.target.reset(); showToast("Client Registered");
    } catch(x) { alert(x.message); }
};

// Client Request Service
window.requestService = async () => {
    const d = document.getElementById('serviceDate').value;
    const s = document.getElementById('serviceStart').value;
    const e = document.getElementById('serviceEnd').value;
    if(!d || !s || !e) return showToast("Fill all fields");
    
    await addDoc(collection(db, "shift_requests"), {
        clientId: currentUserData.uid,
        clientName: currentUserData.name,
        type: 'service',
        date: d, startTime: s, endTime: e,
        status: 'pending',
        createdAt: serverTimestamp()
    });
    showToast("Request Sent");
};

// Open Assignment Modal
window.openAssignModal = async (reqId) => {
    document.getElementById('assignReqId').value = reqId;
    const s = document.getElementById('assignStaffSelect'); s.innerHTML = '';
    const snap = await getDocs(query(collection(db,"users"), where("role","==","member")));
    snap.forEach(d => {
        const u = d.data();
        const o = document.createElement('option');
        o.value = d.id; o.innerText = u.name;
        s.appendChild(o);
    });
    document.getElementById('assignModal').classList.remove('hidden');
};

// Confirm Assignment
// Confirm Assignment
window.confirmAssignment = async () => {
    const rid = document.getElementById('assignReqId').value;
    const uid = document.getElementById('assignStaffSelect').value;
    const uName = document.getElementById('assignStaffSelect').options[document.getElementById('assignStaffSelect').selectedIndex].text;
    
    await updateDoc(doc(db, "shift_requests", rid), {
        status: 'assigned',
        assignedTo: uid,
        userId: uid, // <--- THIS IS THE CRITICAL MISSING LINE
        assignedName: uName
    });
    document.getElementById('assignModal').classList.add('hidden');
    showToast("Staff Assigned");
};

// Squad Member Respond to Job
window.respondJob = async (id, status) => {
    await updateDoc(doc(db, "shift_requests", id), { status: status });
    showToast(status === 'approved' ? "Job Accepted" : "Job Denied");
};

// Collect Client Payment
window.collectClientPayment = async (uid, due) => {
    const amt = prompt(`Collect Payment (Due: ₹${due})`, due);
    if(amt && !isNaN(amt)) {
        await runTransaction(db, async(t) => {
            const ref = doc(db, "users", uid);
            const c = (await t.get(ref)).data();
            t.update(ref, { dueAmount: (c.dueAmount||0) - Number(amt) });
            const pRef = doc(collection(db, "client_payments"));
            t.set(pRef, { clientId: uid, amount: Number(amt), date: serverTimestamp() });
        });
        showToast("Payment Collected");
    }
};

// --- MANAGE SLOTS (Admin/Manager) ---

window.openManageSlot = async (id) => {
    const docSnap = await getDoc(doc(db, "shift_requests", id));
    if (!docSnap.exists()) return showToast("Error: Slot not found");
    const r = docSnap.data();
    
    document.getElementById('manageSlotId').value = id;
    document.getElementById('manageSlotStart').value = r.startTime;
    document.getElementById('manageSlotEnd').value = r.endTime;
    
    // Populate Staff Dropdown
    const s = document.getElementById('manageSlotStaff'); s.innerHTML = '<option value="">Unassigned</option>';
    const usersSnap = await getDocs(query(collection(db,"users"), where("role","==","member")));
    usersSnap.forEach(u => {
        const ud = u.data();
        const selected = (r.assignedTo === u.id || r.userId === u.id) ? 'selected' : '';
        s.innerHTML += `<option value="${u.id}" ${selected}>${ud.name}</option>`;
    });

    document.getElementById('manageSlotModal').classList.remove('hidden');
};

window.saveSlotChanges = async () => {
    const id = document.getElementById('manageSlotId').value;
    const uid = document.getElementById('manageSlotStaff').value;
    const start = document.getElementById('manageSlotStart').value;
    const end = document.getElementById('manageSlotEnd').value;
    const uName = document.getElementById('manageSlotStaff').options[document.getElementById('manageSlotStaff').selectedIndex].text;

    let updates = { 
        startTime: start, 
        endTime: end 
    };

    if (uid) {
        updates.assignedTo = uid;
        updates.userId = uid; // Ensure assigned user sees it
        updates.assignedName = uName;
        updates.status = 'approved'; // Auto-approve if edited by admin/mgr
    } else {
        updates.assignedTo = null;
        updates.userId = null;
        updates.assignedName = null;
        updates.status = 'pending'; // Revert to pending if unassigned
    }

    await updateDoc(doc(db, "shift_requests", id), updates);
    document.getElementById('manageSlotModal').classList.add('hidden');
    showToast("Slot Updated");
};

window.deleteSlotRequest = async () => {
    if(!confirm("Permanently delete this slot? This cannot be undone.")) return;
    const id = document.getElementById('manageSlotId').value;
    await deleteDoc(doc(db, "shift_requests", id));
    document.getElementById('manageSlotModal').classList.add('hidden');
    showToast("Slot Deleted");
};
 
// --- RECHARGE LOGIC ---

window.openRechargeModal = (uid) => {
    document.getElementById('rechargeUid').value = uid;
    document.getElementById('rechargeAmount').value = '';
    document.getElementById('displayFee').innerText = '₹0';
    document.getElementById('displayNet').innerText = '₹0';
    document.getElementById('rechargeModal').classList.remove('hidden');
};

// Live calc for fee
document.getElementById('rechargeAmount').oninput = (e) => {
    const val = Number(e.target.value);
    const fee = val * 0.10; // 10%
    const net = val - fee;
    document.getElementById('displayFee').innerText = `₹${fee.toFixed(0)}`;
    document.getElementById('displayNet').innerText = `₹${net.toFixed(0)}`;
};

window.confirmRecharge = async () => {
    const uid = document.getElementById('rechargeUid').value;
    const amount = Number(document.getElementById('rechargeAmount').value);
    
    if(!amount || amount <= 0) return alert("Invalid Amount");
    
    const fee = amount * 0.10;
    const net = amount - fee;

    try {
        await runTransaction(db, async(t) => {
            const ref = doc(db, "users", uid);
            const u = (await t.get(ref)).data();
            
            // 1. Add Net to Wallet
            t.update(ref, { walletBalance: (u.walletBalance||0) + net });
            
            // 2. Log Recharge Credit
            const creditRef = doc(collection(db, "client_transactions"));
            t.set(creditRef, { 
                clientId: uid, 
                amount: net, 
                type: 'recharge', 
                fullAmount: amount,
                date: serverTimestamp(), 
                details: "Wallet Recharge" 
            });

            // 3. Log Service Fee (Internal Record)
            const feeRef = doc(collection(db, "client_transactions"));
            t.set(feeRef, { 
                clientId: uid, 
                amount: fee, 
                type: 'service_fee', 
                date: serverTimestamp(), 
                details: "10% Service Charge" 
            });
        });
        showToast("Recharge Successful");
        document.getElementById('rechargeModal').classList.add('hidden');
    } catch(e) { alert(e); }
};

window.viewClientHistory = async (uid) => {
    const q = query(collection(db, "client_transactions"), where("clientId", "==", uid), orderBy("date", "desc"), limit(10));
    const snap = await getDocs(q);
    let msg = "Recent Transactions:\n\n";
    if(snap.empty) msg += "No history found.";
    else {
        snap.forEach(d => {
            const t = d.data();
            const sign = t.type === 'recharge' ? '+' : '-';
            msg += `${t.date.toDate().toLocaleDateString()}: ${sign}₹${t.amount} (${t.details})\n`;
        });
    }
    alert(msg); // Simple alert for now to save space
};
       // Login Handler
        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            try { await signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPassword').value); }
            catch(x) { document.getElementById('authError').innerText = "Invalid Credentials"; document.getElementById('authError').classList.remove('hidden'); }
        };
        document.getElementById('logoutBtn').onclick = () => signOut(auth);

    </script>
</body>
</html>
