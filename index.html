<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Juice Therapy - System</title>
    
    <!-- Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkp1aWNlIFRoZXJhcHkgU3F1YWQiLAogICJzaG9ydF9uYW1lIjogIkpUIFNxdWFkIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmZmZmZmYiLAogICJ0aGVtZV9jb2xvciIjogIiNmOTczMTYiCn0=">
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Styles -->
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; background-color: #f8fafc; overscroll-behavior-y: contain; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none !important; }
        .loader { border-top-color: #f97316; animation: spinner 1s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .nav-btn { color: #9ca3af; transition: all 0.2s; }
        .nav-btn.active { color: #ea580c; }
        .nav-btn.active i { transform: translateY(-2px); }
        .admin-tab-btn { transition: all 0.2s; border-bottom: 2px solid transparent; color: #6b7280; }
        .admin-tab-btn.active { border-bottom-color: #ea580c; color: #ea580c; font-weight: 700; background-color: #fff7ed; }
        /* Mobile Optimization */
        input, select, button { touch-action: manipulation; }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col text-gray-800">

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 right-5 bg-gray-900 text-white px-4 py-3 rounded-lg shadow-xl transform translate-x-full transition-transform duration-300 z-[100] font-medium flex items-center gap-3 text-sm max-w-xs">
        <i class="fas fa-info-circle text-orange-400 text-lg"></i> <span id="toastMsg">Notification</span>
    </div>

    <!-- Login Screen -->
    <div id="authSection" class="flex-grow flex flex-col items-center justify-center p-6 bg-orange-50 overflow-y-auto">
        <div class="bg-white p-4 rounded-full shadow-lg mb-6"><img src="logo.png" onerror="this.src='https://via.placeholder.com/150?text=Juice+Therapy'" alt="Logo" class="w-24 h-24 object-contain rounded-full"></div>
        <div class="bg-white p-8 rounded-2xl shadow-sm w-full max-w-md border border-gray-100">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-2">Welcome Back</h2>
            <p class="text-center text-gray-400 text-sm mb-6">Staff Management System</p>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">Email</label>
                    <input type="email" id="loginEmail" required class="w-full p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 outline-none transition" placeholder="staff@juicetherapy.com">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">Password</label>
                    <input type="password" id="loginPassword" required class="w-full p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 outline-none transition" placeholder="••••••••">
                </div>
                <button type="submit" class="w-full py-3.5 bg-orange-600 hover:bg-orange-700 text-white rounded-xl font-bold shadow-lg shadow-orange-200 transition transform active:scale-95">Sign In</button>
            </form>
            <p id="authError" class="text-red-500 text-sm mt-4 text-center hidden bg-red-50 p-3 rounded-lg border border-red-100"></p>
        </div>
    </div>

    <!-- Main App Interface -->
    <div id="appLayout" class="flex-grow flex flex-col hidden h-full">
        
        <!-- Top Bar -->
        <header class="bg-white p-4 shadow-sm flex justify-between items-center z-20 border-b border-gray-100 h-16">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center text-white font-bold text-xs shadow-sm">JT</div>
                <div>
                    <h1 class="font-bold text-sm leading-tight text-gray-800">Juice Therapy</h1>
                    <div class="flex items-center gap-1.5">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                        <p class="text-[10px] text-gray-500 uppercase font-bold tracking-wide" id="headerRoleDisplay">Loading...</p>
                    </div>
                </div>
            </div>
            <div class="flex gap-1">
                <button onclick="window.location.reload()" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-orange-600 hover:bg-orange-50 rounded-full transition"><i class="fas fa-sync-alt text-xs"></i></button>
                <button id="logoutBtn" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full transition"><i class="fas fa-power-off text-xs"></i></button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="mainContent" class="flex-grow overflow-y-auto bg-gray-50 relative pb-24">
            
            <!-- Global Loader -->
            <div id="pageLoader" class="absolute inset-0 flex items-center justify-center bg-white/90 z-50 hidden">
                <div class="flex flex-col items-center">
                    <div class="loader w-10 h-10 rounded-full border-4 border-gray-200 mb-2"></div>
                    <span class="text-xs font-bold text-gray-400">Processing...</span>
                </div>
            </div>

            <!-- ================= ADMIN DASHBOARD ================= -->
            <div id="adminView" class="view-section hidden flex flex-col h-full">
                <!-- Sticky Admin Nav -->
                <div class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-30 overflow-x-auto flex">
                    <button class="flex-1 py-3 text-xs font-bold uppercase tracking-wide admin-tab-btn active" onclick="switchAdminTab('overview', event)"><i class="fas fa-chart-pie mb-1 block text-lg"></i>Dash</button>
                    <button class="flex-1 py-3 text-xs font-bold uppercase tracking-wide admin-tab-btn" onclick="switchAdminTab('users', event)"><i class="fas fa-users mb-1 block text-lg"></i>Staff</button>
                    <button class="flex-1 py-3 text-xs font-bold uppercase tracking-wide admin-tab-btn" onclick="switchAdminTab('shifts', event)"><i class="fas fa-clock mb-1 block text-lg"></i>Shifts</button>
                    <button class="flex-1 py-3 text-xs font-bold uppercase tracking-wide admin-tab-btn" onclick="switchAdminTab('settings', event)"><i class="fas fa-sliders-h mb-1 block text-lg"></i>Config</button>
                </div>

                <div class="p-4 space-y-5">
                    <!-- Tab: Overview -->
                    <div id="adminTab-overview" class="space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm"><p class="text-gray-400 text-[10px] font-bold uppercase">Total Staff</p><p id="adminTotalStaff" class="text-2xl font-bold text-gray-800">0</p></div>
                            <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm"><p class="text-gray-400 text-[10px] font-bold uppercase">Active Shifts</p><p id="adminActiveStaff" class="text-2xl font-bold text-green-600">0</p></div>
                            <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm col-span-2"><p class="text-gray-400 text-[10px] font-bold uppercase">Wallet Liability (Squad)</p><p class="text-2xl font-bold text-gray-800">₹<span id="adminPendingPayout">0</span></p></div>
                        </div>
                        <div class="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden">
                            <div class="p-3 border-b border-gray-50 bg-gray-50/50"><h3 class="font-bold text-xs text-gray-600 uppercase">Live Floor Monitor</h3></div>
                            <div id="adminLiveList" class="p-4 space-y-3 min-h-[100px]"><p class="text-center text-gray-400 text-xs italic py-4">No active shifts.</p></div>
                        </div>
                    </div>

                    <!-- Tab: Users -->
                    <div id="adminTab-users" class="hidden space-y-4">
                        <div class="flex gap-2">
                            <div class="relative flex-grow">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400 text-xs"></i>
                                <input type="text" id="staffSearch" placeholder="Search..." class="w-full pl-8 p-2.5 text-sm rounded-lg border border-gray-200 outline-none focus:border-orange-500">
                            </div>
                            <button onclick="document.getElementById('createUserModal').classList.remove('hidden')" class="bg-gray-800 text-white px-3 rounded-lg"><i class="fas fa-plus"></i></button>
                        </div>
                        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-semibold"><tr><th class="p-3">Staff</th><th class="p-3">Role</th><th class="p-3">Status</th><th class="p-3 text-right">Action</th></tr></thead>
                                    <tbody id="userTableBody" class="divide-y divide-gray-100 text-gray-700"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Shifts -->
                    <div id="adminTab-shifts" class="hidden space-y-4">
                        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                            <div class="p-3 border-b border-gray-50 bg-gray-50/50 flex justify-between items-center">
                                <h3 class="font-bold text-xs text-gray-600 uppercase">Shift History</h3>
                                <span class="text-[10px] text-orange-500 bg-orange-50 px-2 py-1 rounded">Photos kept 7 days</span>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-semibold"><tr><th class="p-3">Date</th><th class="p-3">Name</th><th class="p-3">Timing</th><th class="p-3 text-right">Delete</th></tr></thead>
                                    <tbody id="shiftTableBody" class="divide-y divide-gray-100 text-gray-700"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Settings -->
                    <div id="adminTab-settings" class="hidden space-y-4">
                        <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                            <h3 class="font-bold text-gray-800 text-sm uppercase mb-4 border-b pb-2">Global Logic</h3>
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">Rate (₹/hr)</label><input type="number" id="settingRate" class="w-full p-2 border rounded font-mono"></div>
                                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">Bonus (Pts/hr)</label><input type="number" id="settingBonus" class="w-full p-2 border rounded font-mono"></div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">Radius (m)</label><input type="number" id="settingRadius" class="w-full p-2 border rounded font-mono"></div>
                                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">Train (Days)</label><input type="number" id="settingTraining" class="w-full p-2 border rounded font-mono"></div>
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-gray-400 uppercase">Outlet Location (Lat, Lng)</label>
                                    <div class="flex gap-2">
                                        <input type="number" step="any" id="settingLat" class="w-1/2 p-2 border rounded font-mono text-xs">
                                        <input type="number" step="any" id="settingLng" class="w-1/2 p-2 border rounded font-mono text-xs">
                                    </div>
                                </div>
                                <button id="saveSettingsBtn" class="w-full py-3 bg-gray-800 text-white rounded-lg font-bold text-sm hover:bg-black transition">Save Configuration</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ================= MANAGER OPS CONSOLE ================= -->
            <div id="managerView" class="view-section hidden p-4 space-y-5">
                <div class="bg-white p-4 rounded-xl border-l-4 border-orange-500 shadow-sm flex justify-between items-center">
                    <div>
                        <h2 class="text-lg font-bold text-gray-800">Manager Ops</h2>
                        <p class="text-xs text-gray-500" id="mgrDateDisplay">...</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="window.enterMyZone()" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow hover:bg-blue-700 transition"><i class="fas fa-user-circle mr-1"></i> My Zone</button>
                        <button onclick="window.openRedeemModal()" class="bg-orange-100 text-orange-700 w-8 h-8 rounded-lg flex items-center justify-center hover:bg-orange-200"><i class="fas fa-gift"></i></button>
                    </div>
                </div>

                <!-- Live Floor -->
                <div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
                    <div class="p-3 border-b border-gray-50 bg-gray-50/50 flex justify-between items-center">
                        <h3 class="font-bold text-xs text-gray-600 uppercase">Live Floor</h3>
                        <span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-[10px] font-bold" id="mgrLiveCount">0 Active</span>
                    </div>
                    <div id="liveWorkersList" class="p-4 space-y-3"><p class="text-center text-gray-400 text-xs italic">Floor is clear.</p></div>
                </div>

                <!-- Roster -->
                <div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
                    <div class="p-3 border-b border-gray-50 bg-gray-50/50"><h3 class="font-bold text-xs text-gray-600 uppercase">Approved Roster (Upcoming)</h3></div>
                    <div id="mgrUpcomingList" class="p-4 space-y-3"><p class="text-center text-gray-400 text-xs italic">No upcoming approved slots.</p></div>
                </div>

                <!-- Actions -->
                <div class="grid gap-4">
                    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
                        <div class="p-3 border-b border-gray-50 bg-gray-50/50"><h3 class="font-bold text-xs text-gray-600 uppercase">Requests</h3></div>
                        <div id="slotRequestsList" class="p-4 space-y-3"></div>
                    </div>
                    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
                        <div class="p-3 border-b border-gray-50 bg-gray-50/50"><h3 class="font-bold text-xs text-gray-600 uppercase">Pending Ratings</h3></div>
                        <div id="completedShiftsList" class="p-4 space-y-3"></div>
                    </div>
                </div>
            </div>

            <!-- ================= PERSONAL DASHBOARD (ALL STAFF) ================= -->
            <div id="memberDashboard" class="member-tab hidden p-4 space-y-5">
                
                <!-- Back Button for Managers -->
                <button id="mgrBackBtn" class="hidden w-full bg-gray-800 text-white py-3 rounded-xl font-bold text-sm shadow-lg mb-2" onclick="window.exitMyZone()">
                    <i class="fas fa-arrow-left mr-2"></i> Return to Ops Console
                </button>

                <!-- ID Card -->
                <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl p-5 text-white shadow-xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fas fa-id-card fa-6x"></i></div>
                    <div class="relative z-10">
                        <div class="flex items-center gap-4 mb-5">
                            <div class="w-14 h-14 bg-white rounded-full flex items-center justify-center text-orange-600 font-bold text-xl border-4 border-gray-600" id="memberInitials">JT</div>
                            <div>
                                <h2 class="font-bold text-lg leading-tight" id="memberName">Staff Name</h2>
                                <p class="text-xs text-gray-400 font-mono mb-1">ID: <span id="memberId">...</span></p>
                                <span class="bg-orange-600 text-white text-[10px] uppercase font-bold px-2 py-0.5 rounded" id="memberRoleBadge">Role</span>
                            </div>
                        </div>
                        
                        <!-- Dynamic Stats -->
                        <div class="grid grid-cols-3 gap-2 border-t border-gray-700 pt-4" id="statsGrid">
                            <!-- Injected JS -->
                        </div>
                    </div>
                </div>

                <!-- Training Warning -->
                <div id="blockedFundsAlert" class="bg-orange-50 border border-orange-200 rounded-xl p-3 flex items-center gap-3 hidden">
                    <div class="bg-orange-100 text-orange-600 w-8 h-8 rounded-full flex items-center justify-center shrink-0"><i class="fas fa-lock text-xs"></i></div>
                    <div>
                        <p class="text-xs font-bold text-gray-700">Training Period Active</p>
                        <p class="text-[10px] text-gray-500">Held Funds: <span class="font-bold text-gray-800">₹<span id="memberBlockedWallet">0</span></span></p>
                    </div>
                </div>

                <!-- Upcoming Slots (Squad Only) -->
                <div id="memberUpcomingSlots" class="bg-blue-50 border border-blue-100 rounded-xl p-4 hidden">
                    <h3 class="font-bold text-blue-800 text-xs uppercase mb-2"><i class="fas fa-calendar-check mr-2"></i>Upcoming Shifts</h3>
                    <div id="memberUpcomingList" class="space-y-2 text-sm text-blue-700"></div>
                </div>

                <!-- Attendance Action -->
                <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm text-center">
                    <h3 class="font-bold text-xs text-gray-400 uppercase mb-4 tracking-wider">Attendance</h3>
                    
                    <div id="checkInBtnArea">
                        <button id="checkInBtn" class="w-full py-4 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold text-lg shadow-lg shadow-green-100 transition active:scale-95 flex items-center justify-center gap-2">
                            <i class="fas fa-camera"></i> CHECK IN
                        </button>
                        <p class="text-[10px] text-gray-400 mt-2"><i class="fas fa-map-marker-alt mr-1"></i> Location Verified</p>
                    </div>

                    <div id="checkOutBtnArea" class="hidden">
                        <div class="inline-block px-3 py-1 bg-red-50 text-red-600 rounded-full text-xs font-bold mb-3 animate-pulse">ON DUTY</div>
                        <div class="text-4xl font-mono font-bold text-gray-800 mb-4 tracking-tight" id="workTimer">00:00:00</div>
                        <button id="checkOutBtn" class="w-full py-4 bg-gray-900 hover:bg-black text-white rounded-xl font-bold text-lg shadow-lg transition active:scale-95">END SHIFT</button>
                    </div>
                    
                    <p id="geoError" class="text-red-500 text-xs mt-3 hidden bg-red-50 p-2 rounded border border-red-100 font-bold"></p>
                </div>

                <!-- Booking / Leave -->
                <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                    <h3 class="font-bold text-xs text-gray-400 uppercase mb-4 tracking-wider" id="bookingTitle">Book Slot</h3>
                    <div class="space-y-3">
                        <div class="flex gap-2">
                            <input type="time" id="bookStartTime" class="w-1/2 p-3 border border-gray-200 rounded-lg bg-gray-50 text-sm">
                            <input type="time" id="bookEndTime" class="w-1/2 p-3 border border-gray-200 rounded-lg bg-gray-50 text-sm">
                        </div>
                        <button id="bookSlotBtn" class="w-full py-3 bg-orange-50 text-orange-600 hover:bg-orange-100 border border-orange-100 rounded-lg font-bold text-sm transition">Request</button>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="memberHistory" class="member-tab hidden p-4 pb-24 space-y-4">
                <h2 class="text-lg font-bold text-gray-800 px-1">Work History</h2>
                <div id="historyList" class="space-y-3"></div>
            </div>

            <!-- Profile Tab -->
            <div id="memberProfile" class="member-tab hidden p-4 pb-24 space-y-4">
                <div class="bg-white rounded-xl border border-gray-200 p-6 text-center shadow-sm">
                     <div class="w-20 h-20 bg-gray-100 rounded-full mx-auto mb-3 flex items-center justify-center text-2xl text-gray-400 font-bold" id="profileInitials">JT</div>
                     <h2 class="text-lg font-bold text-gray-800" id="profileName">User</h2>
                     <p class="text-xs text-gray-500 mb-3" id="profileEmail">email@example.com</p>
                     <span class="inline-block bg-gray-100 text-gray-600 text-[10px] px-3 py-1 rounded-full font-bold">Joined: <span id="profileJoined">-</span></span>
                </div>
                
                <div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
                    <div class="p-3 border-b border-gray-50 bg-gray-50/50"><h3 class="font-bold text-xs text-gray-600 uppercase">Performance Summary</h3></div>
                    <div class="p-4 space-y-3 text-sm">
                        <div class="flex justify-between"><span class="text-gray-500">Total Worked</span><span class="font-bold"><span id="profileDays">0</span> Days</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Total Hours</span><span class="font-bold"><span id="profileHours">0</span> Hrs</span></div>
                        <div id="profileStrikesRow" class="flex justify-between text-red-500"><span class="text-gray-500">Strikes</span><span class="font-bold" id="profileStrikes">0</span></div>
                    </div>
                </div>

                <div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
                    <div class="p-3 border-b border-gray-50 bg-gray-50/50"><h3 class="font-bold text-xs text-gray-600 uppercase">Payment Records</h3></div>
                    <div id="payoutHistoryList" class="p-4 space-y-2 text-xs text-gray-500"><p class="text-center italic">No records found.</p></div>
                </div>
            </div>

            <!-- ================= MODALS ================= -->

            <!-- Camera Modal -->
            <div id="cameraModal" class="fixed inset-0 bg-black z-[100] hidden flex flex-col">
                <div class="relative flex-grow bg-black">
                    <video id="videoElement" autoplay playsinline class="w-full h-full object-cover"></video>
                    <canvas id="canvasElement" class="hidden"></canvas>
                    <div class="absolute top-0 left-0 right-0 p-4 bg-gradient-to-b from-black/60 to-transparent text-white text-center text-sm font-bold">Face Verification Required</div>
                </div>
                <div class="h-32 bg-black flex items-center justify-center gap-8 pb-4">
                    <button id="closeCameraBtn" class="w-12 h-12 rounded-full bg-gray-800 text-white flex items-center justify-center"><i class="fas fa-times"></i></button>
                    <button id="captureBtn" class="w-20 h-20 rounded-full bg-white border-4 border-gray-400 active:scale-90 transition"></button>
                    <div class="w-12"></div>
                </div>
            </div>

            <!-- Create User Modal -->
            <div id="createUserModal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl w-full max-w-md overflow-hidden">
                    <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <h3 class="font-bold text-sm text-gray-700">Add New Staff</h3>
                        <button onclick="document.getElementById('createUserModal').classList.add('hidden')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
                    </div>
                    <form id="createUserForm" class="p-5 space-y-4">
                        <input type="text" id="newUserName" class="w-full p-3 border rounded-lg text-sm" placeholder="Full Name" required>
                        <input type="email" id="newUserEmail" class="w-full p-3 border rounded-lg text-sm" placeholder="Email" required>
                        <input type="password" id="newUserPassword" class="w-full p-3 border rounded-lg text-sm" placeholder="Password (min 6 chars)" required>
                        <select id="newUserRole" class="w-full p-3 border rounded-lg text-sm bg-white">
                            <option value="member">Squad Member (Hourly + Wallet)</option>
                            <option value="fulltime">Full Time Staff (Salary + Leaves)</option>
                            <option value="manager">Manager (Ops + Full Time)</option>
                            <option value="admin">System Admin</option>
                        </select>
                        <button type="submit" class="w-full py-3 bg-gray-900 text-white rounded-xl font-bold text-sm">Create Account</button>
                    </form>
                </div>
            </div>

            <!-- Edit User Modal -->
            <div id="editUserModal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl w-full max-w-sm overflow-hidden">
                    <div class="p-4 border-b border-gray-100 bg-gray-50"><h3 class="font-bold text-sm text-gray-700">Edit Staff Details</h3></div>
                    <div class="p-5 space-y-3">
                        <input type="hidden" id="editUserId">
                        <div class="space-y-1">
                            <label class="text-[10px] uppercase font-bold text-gray-400">Name</label>
                            <input type="text" id="editUserName" class="w-full border p-2 rounded text-sm">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] uppercase font-bold text-gray-400">Role</label>
                            <select id="editUserRole" class="w-full border p-2 rounded text-sm bg-white"><option value="member">Squad</option><option value="fulltime">Full Time</option><option value="manager">Manager</option><option value="admin">Admin</option></select>
                        </div>
                        
                        <!-- Squad Fields -->
                        <div id="squadFields" class="grid grid-cols-2 gap-3 pt-2 border-t border-gray-100">
                            <div><label class="text-[10px] font-bold text-gray-400">Wallet (₹)</label><input type="number" id="editUserWallet" class="w-full border p-2 rounded text-sm"></div>
                            <div><label class="text-[10px] font-bold text-gray-400">Bonus (Pts)</label><input type="number" id="editUserBonus" class="w-full border p-2 rounded text-sm"></div>
                            <div><label class="text-[10px] font-bold text-red-400">Blocked (₹)</label><input type="number" id="editUserBlocked" class="w-full border p-2 rounded text-sm bg-red-50"></div>
                            <div><label class="text-[10px] font-bold text-red-400">Strikes</label><input type="number" id="editUserStrikes" class="w-full border p-2 rounded text-sm bg-red-50"></div>
                        </div>
                        
                        <div class="flex gap-2 mt-4 pt-2">
                            <button id="releaseFundsBtn" class="flex-1 py-2 bg-green-100 text-green-700 rounded-lg text-xs font-bold">Release Blocked</button>
                            <button id="saveUserChangesBtn" class="flex-1 py-2 bg-blue-600 text-white rounded-lg text-xs font-bold">Save Changes</button>
                        </div>
                        <button onclick="document.getElementById('editUserModal').classList.add('hidden')" class="w-full mt-2 text-xs text-gray-400">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Payout Modal -->
            <div id="payoutModal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl w-full max-w-sm p-6">
                    <h3 class="text-lg font-bold mb-1">Process Payment</h3>
                    <p class="text-xs text-gray-500 mb-4" id="payoutSubtitle">Record transaction</p>
                    <form id="payoutForm" class="space-y-4">
                        <input type="hidden" id="payoutUid">
                        <input type="hidden" id="payoutMax"> <!-- -1 for unlimited/salary -->
                        <input type="number" id="payoutAmount" class="w-full p-3 border rounded-lg text-lg font-bold text-center" placeholder="₹0.00" required>
                        <div class="flex gap-2">
                            <button type="button" onclick="document.getElementById('payoutModal').classList.add('hidden')" class="flex-1 py-3 border rounded-xl font-bold">Cancel</button>
                            <button type="submit" class="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold">Confirm</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Redeem Modal -->
            <div id="redeemModal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl w-full max-w-sm p-6">
                    <h3 class="text-lg font-bold mb-4">Redeem Food Points</h3>
                    <form id="redeemForm" class="space-y-3">
                        <select id="redeemUserSelect" class="w-full p-3 border rounded-lg text-sm bg-gray-50" required></select>
                        <input type="number" id="redeemAmount" class="w-full p-3 border rounded-lg text-sm" placeholder="Points to Redeem" required>
                        <input type="text" id="redeemDesc" class="w-full p-3 border rounded-lg text-sm" placeholder="Description (e.g. Sandwich)" required>
                        <div class="flex gap-2 pt-2">
                            <button type="button" onclick="document.getElementById('redeemModal').classList.add('hidden')" class="flex-1 py-3 border rounded-xl font-bold text-sm">Cancel</button>
                            <button type="submit" class="flex-1 py-3 bg-orange-600 text-white rounded-xl font-bold text-sm">Redeem</button>
                        </div>
                    </form>
                </div>
            </div>

        </main>

        <!-- Bottom Navigation (Member/Personal) -->
        <nav class="bg-white shadow-[0_-4px_20px_rgba(0,0,0,0.05)] border-t border-gray-100 p-2 flex justify-around items-center z-40 hidden fixed bottom-0 w-full" id="bottomNav">
            <button class="nav-btn active flex-1 flex flex-col items-center p-2 rounded-lg" onclick="switchMemberTab('dashboard')"><i class="fas fa-home text-xl mb-1"></i><span class="text-[10px] font-bold">Home</span></button>
            <button class="nav-btn flex-1 flex flex-col items-center p-2 rounded-lg" onclick="switchMemberTab('history')"><i class="fas fa-history text-xl mb-1"></i><span class="text-[10px] font-bold">History</span></button>
            <button class="nav-btn flex-1 flex flex-col items-center p-2 rounded-lg" onclick="switchMemberTab('profile')"><i class="fas fa-user text-xl mb-1"></i><span class="text-[10px] font-bold">Profile</span></button>
        </nav>
    </div>

    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, getDoc, getDocs, setDoc, updateDoc, onSnapshot, query, where, orderBy, limit, deleteDoc, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // Config
        const firebaseConfig = { apiKey: "AIzaSyCtrDxf2S2Zp1hY1RMJQzLHb9TGnup4SLE", authDomain: "jt-squad-manager.firebaseapp.com", projectId: "jt-squad-manager", storageBucket: "jt-squad-manager.firebasestorage.app", messagingSenderId: "444609515858", appId: "1:444609515858:web:0e4d00cf14a107618bea8b" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const secondaryApp = initializeApp(firebaseConfig, "Secondary");
        const secondaryAuth = getAuth(secondaryApp);

        let APP_CONFIG = { hourlyRate: 30, bonusRate: 5, radius: 200, trainingDays: 30, outletLat: 13.024976, outletLng: 77.562472 };
        let currentUserData = null, workTimerInterval = null, currentShiftId = null, listeners = [];

        // --- AUTH & INIT ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('appLayout').classList.remove('hidden');
                await loadSettings();
                
                // Real-time Profile Listener
                listeners.push(onSnapshot(doc(db, "users", user.uid), (docSnap) => {
                    if (docSnap.exists()) {
                        currentUserData = { uid: user.uid, ...docSnap.data() };
                        renderRouter();
                    } else {
                        signOut(auth);
                    }
                }));
            } else {
                listeners.forEach(u => u()); listeners = [];
                document.getElementById('authSection').classList.remove('hidden');
                document.getElementById('appLayout').classList.add('hidden');
                document.getElementById('bottomNav').classList.add('hidden');
            }
        });

        async function loadSettings() {
            try { const s = await getDoc(doc(db, "settings", "global")); if(s.exists()) APP_CONFIG = { ...APP_CONFIG, ...s.data() }; } catch(e){}
        }

        // --- ROUTER ---
        function renderRouter() {
            const role = currentUserData.role;
            const views = ['adminView', 'managerView', 'memberDashboard'];
            const nav = document.getElementById('bottomNav');
            
            document.getElementById('headerRoleDisplay').innerText = role.replace('member', 'Squad').toUpperCase();

            // Default State: Hide All
            views.forEach(v => document.getElementById(v).classList.add('hidden'));
            nav.classList.add('hidden');

            // Route Logic
            if (role === 'admin') {
                document.getElementById('adminView').classList.remove('hidden');
                initAdmin();
            } else if (role === 'manager') {
                // Check if user manually switched to "My Zone"
                if (window.isMyZoneActive) {
                    document.getElementById('memberDashboard').classList.remove('hidden');
                    nav.classList.remove('hidden');
                    initMember();
                } else {
                    document.getElementById('managerView').classList.remove('hidden');
                    initManager();
                }
            } else {
                // Member / Full Time
                document.getElementById('memberDashboard').classList.remove('hidden');
                nav.classList.remove('hidden');
                initMember();
            }
        }

        // --- ADMIN CONTROLLER ---
        function initAdmin() {
            // Auto Clean Photos > 7 Days
            (async () => {
                const d = new Date(); d.setDate(d.getDate()-7);
                const q = query(collection(db,"shifts"), where("checkInTime", "<", d), limit(10));
                const snap = await getDocs(q);
                snap.forEach(d => { if(d.data().photo) updateDoc(doc(db,"shifts",d.id), { photo: null }); });
            })();

            // 1. Staff List
            listeners.push(onSnapshot(query(collection(db, "users")), (snap) => {
                const tbody = document.getElementById('userTableBody'); tbody.innerHTML = '';
                let tot = 0, liab = 0;
                snap.forEach(d => {
                    const u = d.data(); tot++; 
                    if(u.role==='member') liab += (u.mainWallet||0);
                    
                    const isSquad = u.role === 'member';
                    const funds = isSquad ? 
                        `<div><span class="font-bold">₹${(u.mainWallet||0).toFixed(0)}</span> <span class="text-xs text-orange-500">(${u.bonusWallet||0}p)</span></div><div class="text-[10px] text-red-400">Blk: ₹${u.blockedWallet||0}</div>` : 
                        `<span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500 font-bold">Salary Mode</span>`;
                    
                    const perf = isSquad ? 
                        `<span class="text-red-500 font-bold text-xs">${u.strikes||0} Strikes</span> | <span class="text-yellow-600">★${u.rating||5}</span>` :
                        `<span class="text-xs text-blue-600 font-bold">${u.totalDays||0} Days</span>`;

                    const tr = document.createElement('tr'); tr.className="border-b hover:bg-gray-50";
                    tr.innerHTML = `
                        <td class="p-3"><div class="font-bold">${u.name}</div><span class="text-[10px] uppercase font-bold text-gray-400">${u.role}</span></td>
                        <td class="p-3 text-sm">${funds}</td>
                        <td class="p-3 text-sm">${perf}</td>
                        <td class="p-3 text-right flex gap-1 justify-end">
                            <button onclick="window.promptPay('${d.id}', ${u.mainWallet||0}, ${!isSquad})" class="bg-green-50 text-green-600 p-2 rounded hover:bg-green-100"><i class="fas fa-money-bill-wave"></i></button>
                            <button onclick="window.editUser('${d.id}')" class="bg-blue-50 text-blue-600 p-2 rounded hover:bg-blue-100"><i class="fas fa-edit"></i></button>
                            <button onclick="window.deleteUser('${d.id}')" class="bg-red-50 text-red-600 p-2 rounded hover:bg-red-100"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                document.getElementById('adminTotalStaff').innerText = tot; 
                document.getElementById('adminPendingPayout').innerText = liab.toFixed(0);
            }));

            // 2. Shifts
            listeners.push(onSnapshot(query(collection(db, "shifts"), orderBy("checkInTime", "desc"), limit(20)), (snap) => {
                const b = document.getElementById('shiftTableBody'); b.innerHTML='';
                snap.forEach(d => {
                    const s = d.data();
                    const tr = document.createElement('tr'); tr.className="border-b";
                    tr.innerHTML = `<td class="p-3 text-xs">${s.checkInTime?.toDate().toLocaleDateString()}</td><td class="p-3 font-bold">${s.userName}</td><td class="p-3 text-xs text-gray-500">${s.hoursWorked?.toFixed(2)||'Active'}h</td><td class="p-3 text-right"><button onclick="window.delShift('${d.id}')" class="text-red-400"><i class="fas fa-trash"></i></button></td>`;
                    b.appendChild(tr);
                });
            }));

            // Init Settings
            document.getElementById('settingRate').value = APP_CONFIG.hourlyRate;
            document.getElementById('settingBonus').value = APP_CONFIG.bonusRate;
            document.getElementById('settingRadius').value = APP_CONFIG.radius;
            document.getElementById('settingTraining').value = APP_CONFIG.trainingDays;
            document.getElementById('settingLat').value = APP_CONFIG.outletLat;
            document.getElementById('settingLng').value = APP_CONFIG.outletLng;
        }

        // --- MANAGER CONTROLLER ---
        function initManager() {
            const today = new Date(); document.getElementById('mgrDateDisplay').innerText = today.toDateString();
            
            // Live View
            listeners.push(onSnapshot(query(collection(db, "shifts"), where("status", "==", "active")), (snap) => {
                const l = document.getElementById('liveWorkersList'); l.innerHTML = '';
                document.getElementById('mgrLiveCount').innerText = snap.size + " Active";
                if(snap.empty) l.innerHTML = '<p class="text-gray-400 text-center text-xs italic py-4">Floor Clear</p>';
                snap.forEach(d => {
                    const s = d.data();
                    const start = s.checkInTime.toDate();
                    const el = document.createElement('div'); el.className="flex justify-between items-center bg-green-50 p-3 rounded-lg border border-green-100";
                    el.innerHTML = `<div><p class="font-bold text-sm">${s.userName}</p><p class="text-[10px] text-green-700 font-mono">In: ${start.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</p></div><button onclick="window.forceStop('${d.id}')" class="text-xs bg-white border border-red-200 text-red-500 px-2 py-1 rounded hover:bg-red-50">End Shift</button>`;
                    l.appendChild(el);
                });
            }));

            // Roster (Approved Future)
            const todayStr = today.toISOString().split('T')[0];
            listeners.push(onSnapshot(query(collection(db, "shift_requests"), where("status", "==", "approved"), where("date", ">=", todayStr)), (snap) => {
                const l = document.getElementById('mgrUpcomingList'); l.innerHTML = '';
                snap.forEach(d => {
                    const r = d.data();
                    const el = document.createElement('div'); el.className="flex justify-between items-center bg-blue-50 p-3 rounded-lg border border-blue-100";
                    el.innerHTML = `<div><p class="font-bold text-sm">${r.userName}</p><p class="text-xs text-blue-600">${r.date} | ${r.startTime}-${r.endTime}</p></div>`;
                    l.appendChild(el);
                });
            }));

            // Requests
            listeners.push(onSnapshot(query(collection(db, "shift_requests"), where("status", "==", "pending")), (snap) => {
                const l = document.getElementById('slotRequestsList'); l.innerHTML = '';
                snap.forEach(d => {
                    const r = d.data();
                    const type = r.type === 'leave' ? '<span class="text-red-600 font-bold">LEAVE</span>' : 'SHIFT';
                    const el = document.createElement('div'); el.className="bg-gray-50 p-3 rounded-lg flex justify-between items-center border border-gray-200";
                    el.innerHTML = `<div><p class="font-bold text-sm">${r.userName} <span class="text-[10px] bg-gray-200 px-1 rounded">${type}</span></p><p class="text-xs text-gray-500">${r.date}</p></div><div class="flex gap-2"><button onclick="window.handleReq('${d.id}','approved')" class="text-green-500 hover:bg-green-100 p-1 rounded"><i class="fas fa-check"></i></button><button onclick="window.handleReq('${d.id}','rejected')" class="text-red-500 hover:bg-red-100 p-1 rounded"><i class="fas fa-times"></i></button></div>`;
                    l.appendChild(el);
                });
            }));
        }

        // --- MEMBER / PERSONAL CONTROLLER ---
        function initMember() {
            const d = currentUserData;
            const isSquad = d.role === 'member';
            const isFullTime = d.role === 'fulltime' || d.role === 'manager';

            // UI Customization based on Role
            document.getElementById('memberRoleBadge').innerText = isSquad ? "SQUAD MEMBER" : (d.role === 'manager' ? "MANAGER" : "FULL TIME");
            document.getElementById('mgrBackBtn').classList.toggle('hidden', d.role !== 'manager');
            document.getElementById('memberId').innerText = d.uid.substring(0,6).toUpperCase();
            document.getElementById('memberName').innerText = d.name;
            document.getElementById('memberInitials').innerText = d.name.substring(0,2).toUpperCase();
            document.getElementById('profileName').innerText = d.name;
            document.getElementById('profileEmail').innerText = d.email;
            document.getElementById('profileJoined').innerText = d.joinedAt?.toDate().toLocaleDateString() || '-';

            // Stats Grid
            const grid = document.getElementById('statsGrid');
            if (isSquad) {
                grid.innerHTML = `
                    <div class="text-center p-2 rounded-lg bg-gray-800/50"><p class="text-[10px] uppercase text-gray-400 mb-1">Wallet</p><p class="font-bold text-lg">₹${(d.mainWallet||0).toFixed(0)}</p></div>
                    <div class="text-center p-2 rounded-lg bg-gray-800/50"><p class="text-[10px] uppercase text-gray-400 mb-1">Points</p><p class="font-bold text-lg text-orange-400">${d.bonusWallet||0}</p></div>
                    <div class="text-center p-2 rounded-lg bg-gray-800/50"><p class="text-[10px] uppercase text-gray-400 mb-1">Rating</p><p class="font-bold text-lg text-yellow-400">${d.rating||5}</p></div>
                `;
                // Check Training
                const days = Math.floor((new Date() - (d.joinedAt?.toDate()||new Date()))/86400000);
                if (days < APP_CONFIG.trainingDays) {
                    document.getElementById('blockedFundsAlert').classList.remove('hidden');
                    document.getElementById('memberBlockedWallet').innerText = (d.blockedWallet||0).toFixed(0);
                }
                document.getElementById('profileStrikes').innerText = d.strikes||0;
                document.getElementById('bookingTitle').innerText = "Book Shift";
                document.getElementById('bookSlotBtn').innerText = "Request Shift";
            } else {
                grid.innerHTML = `
                    <div class="text-center p-2 rounded-lg bg-gray-800/50"><p class="text-[10px] uppercase text-gray-400 mb-1">Days</p><p class="font-bold text-lg">${d.totalDays||0}</p></div>
                    <div class="text-center p-2 rounded-lg bg-gray-800/50"><p class="text-[10px] uppercase text-gray-400 mb-1">Leaves</p><p class="font-bold text-lg text-red-400">${d.leavesTaken||0}</p></div>
                    <div class="text-center p-2 rounded-lg bg-gray-800/50"><p class="text-[10px] uppercase text-gray-400 mb-1">Hours</p><p class="font-bold text-lg">${(d.totalHours||0).toFixed(0)}</p></div>
                `;
                document.getElementById('profileStrikesRow').classList.add('hidden');
                document.getElementById('bookingTitle').innerText = "Request Leave";
                document.getElementById('bookSlotBtn').innerText = "Submit Leave Request";
            }

            // Active Shift Monitor
            listeners.push(onSnapshot(query(collection(db, "shifts"), where("userId", "==", d.uid), where("status", "==", "active")), (snap) => {
                const inBtn = document.getElementById('checkInBtnArea');
                const outBtn = document.getElementById('checkOutBtnArea');
                
                if(!snap.empty) {
                    currentShiftId = snap.docs[0].id;
                    const start = snap.docs[0].data().checkInTime.toDate();
                    inBtn.classList.add('hidden');
                    outBtn.classList.remove('hidden');
                    
                    if(workTimerInterval) clearInterval(workTimerInterval);
                    workTimerInterval = setInterval(() => {
                        const diff = new Date() - start;
                        document.getElementById('workTimer').innerText = new Date(diff).toISOString().substr(11, 8);
                    }, 1000);
                } else {
                    currentShiftId = null;
                    inBtn.classList.remove('hidden');
                    outBtn.classList.add('hidden');
                    if(workTimerInterval) clearInterval(workTimerInterval);
                }
            }));

            // Upcoming Shifts (Squad Only)
            if (isSquad) {
                const todayStr = new Date().toISOString().split('T')[0];
                listeners.push(onSnapshot(query(collection(db, "shift_requests"), where("userId", "==", d.uid), where("status", "==", "approved"), where("date", ">=", todayStr)), (snap) => {
                    const l = document.getElementById('memberUpcomingList'); l.innerHTML = '';
                    const c = document.getElementById('memberUpcomingSlots');
                    if(snap.empty) c.classList.add('hidden');
                    else {
                        c.classList.remove('hidden');
                        snap.forEach(d => {
                            const r = d.data();
                            l.innerHTML += `<div class="flex justify-between border-b border-blue-100 pb-1"><span>${r.date}</span><span class="font-bold">${r.startTime}-${r.endTime}</span></div>`;
                        });
                    }
                }));
            }

            // History & Payouts
            loadHistory();
            loadPayouts();
        }

        async function loadHistory() {
            const q = query(collection(db, "shifts"), where("userId", "==", currentUserData.uid), where("status", "==", "completed"));
            const snap = await getDocs(q);
            let shifts = [];
            snap.forEach(d => shifts.push(d.data()));
            shifts.sort((a,b) => b.checkOutTime - a.checkOutTime); // Client sort

            const l = document.getElementById('historyList'); l.innerHTML = '';
            let wkHours = 0; const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate()-7);

            shifts.slice(0, 15).forEach(s => {
                const start = s.checkInTime.toDate();
                const end = s.checkOutTime.toDate();
                if (end > weekAgo) wkHours += (s.hoursWorked||0);

                const timeStr = `${start.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} - ${end.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
                const earn = currentUserData.role === 'member' ? `<span class="text-green-600 font-bold text-xs">₹${s.earnings?.toFixed(0)}</span>` : '';

                const el = document.createElement('div');
                el.className = "bg-white p-3 rounded-lg border border-gray-100 flex justify-between items-center";
                el.innerHTML = `
                    <div>
                        <div class="text-xs font-bold text-gray-700">${end.toLocaleDateString()}</div>
                        <div class="text-[10px] text-gray-400 font-mono mt-1">${timeStr}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-bold text-gray-600">${s.hoursWorked?.toFixed(2)}h</div>
                        ${earn}
                    </div>
                `;
                l.appendChild(el);
            });
            document.getElementById('profileDays').innerText = shifts.length; // Approximate days
            document.getElementById('profileHours').innerText = (currentUserData.totalHours||0).toFixed(1);
        }

        async function loadPayouts() {
            const snap = await getDocs(query(collection(db, "payouts"), where("userId", "==", currentUserData.uid), orderBy("date", "desc"), limit(10)));
            const l = document.getElementById('payoutHistoryList'); 
            if(snap.empty) { l.innerHTML = '<p class="text-center italic text-gray-400">No records found.</p>'; return; }
            l.innerHTML = '';
            snap.forEach(d => {
                const p = d.data();
                l.innerHTML += `<div class="flex justify-between border-b border-gray-50 pb-2 mb-2"><span class="text-gray-600">${p.date.toDate().toLocaleDateString()}</span><span class="font-bold text-green-600">+₹${p.amount}</span></div>`;
            });
        }

        // --- GLOBAL HANDLERS ---
        window.switchAdminTab = (t, e) => {
            document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active')); e.currentTarget.classList.add('active');
            ['overview','users','shifts','settings'].forEach(k => document.getElementById(`adminTab-${k}`).classList.add('hidden'));
            document.getElementById(`adminTab-${t}`).classList.remove('hidden');
        };

        window.switchMemberTab = (t) => {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); 
            event.currentTarget.classList.add('active');
            ['Dashboard','History','Profile'].forEach(k => document.getElementById('member'+k).classList.add('hidden'));
            document.getElementById('member'+t.charAt(0).toUpperCase()+t.slice(1)).classList.remove('hidden');
        };

        // Manager Zones
        window.enterMyZone = () => { window.isMyZoneActive = true; renderRouter(); };
        window.exitMyZone = () => { window.isMyZoneActive = false; renderRouter(); };

        // Payout
        window.promptPay = (uid, bal, isFullTime) => {
            document.getElementById('payoutUid').value = uid;
            document.getElementById('payoutMax').value = isFullTime ? -1 : bal;
            document.getElementById('payoutSubtitle').innerText = isFullTime ? "Salary Payment Record" : `Deduct from Wallet (Max: ₹${bal})`;
            document.getElementById('payoutModal').classList.remove('hidden');
        };

        document.getElementById('payoutForm').onsubmit = async (e) => {
            e.preventDefault();
            const uid = document.getElementById('payoutUid').value;
            const max = Number(document.getElementById('payoutMax').value);
            const amt = Number(document.getElementById('payoutAmount').value);
            
            if(max !== -1 && amt > max) return showToast("Insufficient Wallet Balance");

            try {
                await runTransaction(db, async(t) => {
                    const userRef = doc(db, "users", uid);
                    const userDoc = await t.get(userRef);
                    if(max !== -1) {
                        const newBal = (userDoc.data().mainWallet || 0) - amt;
                        if(newBal < 0) throw "Balance changed";
                        t.update(userRef, { mainWallet: newBal });
                    }
                    const payRef = doc(collection(db, "payouts"));
                    t.set(payRef, { userId: uid, amount: amt, date: serverTimestamp(), by: currentUserData.name });
                    const auditRef = doc(collection(db, "audit_logs"));
                    t.set(auditRef, { action: "Payout", details: `Paid ${amt} to ${uid}`, time: serverTimestamp(), by: currentUserData.name });
                });
                showToast("Payment Recorded Successfully");
                document.getElementById('payoutModal').classList.add('hidden'); e.target.reset();
            } catch(err) { alert(err); }
        };

        // Edit User
        window.editUser = async (uid) => {
            const u = (await getDoc(doc(db,"users",uid))).data();
            document.getElementById('editUserId').value = uid;
            document.getElementById('editUserName').value = u.name;
            document.getElementById('editUserRole').value = u.role;
            
            // Show/Hide Fields based on Role
            const isSquad = u.role === 'member';
            document.getElementById('squadFields').classList.toggle('hidden', !isSquad);
            
            if(isSquad) {
                document.getElementById('editUserWallet').value = u.mainWallet||0;
                document.getElementById('editUserBonus').value = u.bonusWallet||0;
                document.getElementById('editUserBlocked').value = u.blockedWallet||0;
                document.getElementById('editUserStrikes').value = u.strikes||0;
            }
            document.getElementById('editUserModal').classList.remove('hidden');
            
            // Release Handler
            document.getElementById('releaseFundsBtn').onclick = async () => {
                if(!confirm("Move blocked training funds to main wallet?")) return;
                await updateDoc(doc(db,"users",uid), { mainWallet: (u.mainWallet||0)+(u.blockedWallet||0), blockedWallet: 0 });
                showToast("Funds Released"); document.getElementById('editUserModal').classList.add('hidden');
            };
        };

        document.getElementById('saveUserChangesBtn').onclick = async () => {
            const uid = document.getElementById('editUserId').value;
            const r = document.getElementById('editUserRole').value;
            const updates = { name: document.getElementById('editUserName').value, role: r };
            
            if(r === 'member') {
                updates.mainWallet = Number(document.getElementById('editUserWallet').value);
                updates.bonusWallet = Number(document.getElementById('editUserBonus').value);
                updates.blockedWallet = Number(document.getElementById('editUserBlocked').value);
                updates.strikes = Number(document.getElementById('editUserStrikes').value);
            }
            await updateDoc(doc(db,"users",uid), updates);
            document.getElementById('editUserModal').classList.add('hidden');
            showToast("Profile Updated");
        };

        // Attendance Logic
        document.getElementById('checkInBtn').onclick = () => {
            if(!navigator.geolocation) return alert("Geolocation Access Required");
            const btn = document.getElementById('checkInBtn'); btn.innerText = "Locating...";
            navigator.geolocation.getCurrentPosition(pos => {
                const dist = getDist(pos.coords.latitude, pos.coords.longitude, APP_CONFIG.outletLat, APP_CONFIG.outletLng);
                if (dist*1000 <= APP_CONFIG.radius) {
                    navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}}).then(stream => {
                        const v = document.getElementById('videoElement'); v.srcObject = stream;
                        document.getElementById('cameraModal').classList.remove('hidden');
                        document.getElementById('captureBtn').onclick = async () => {
                            const c = document.getElementById('canvasElement'); c.width=v.videoWidth; c.height=v.videoHeight;
                            c.getContext('2d').drawImage(v,0,0);
                            const photo = c.toDataURL('image/jpeg', 0.4);
                            stream.getTracks().forEach(t=>t.stop());
                            document.getElementById('cameraModal').classList.add('hidden');
                            await addDoc(collection(db, "shifts"), { userId: currentUserData.uid, userName: currentUserData.name, checkInTime: serverTimestamp(), status: 'active', photo: photo });
                            showToast("Check In Successful!");
                        };
                        document.getElementById('closeCameraBtn').onclick = () => { stream.getTracks().forEach(t=>t.stop()); document.getElementById('cameraModal').classList.add('hidden'); btn.innerText="CHECK IN"; };
                    }).catch(e => { alert("Camera Error: " + e); btn.innerText="CHECK IN"; });
                } else {
                    btn.innerText="CHECK IN";
                    document.getElementById('geoError').innerText = `You are ${(dist*1000).toFixed(0)}m away. Move closer.`;
                    document.getElementById('geoError').classList.remove('hidden');
                }
            }, err => { alert("GPS Error"); btn.innerText="CHECK IN"; }, {enableHighAccuracy: true});
        };

        // Shift End Logic (Force Stop & Self Checkout use same logic)
        window.forceStop = async (id) => {
            if(!confirm("End this shift?")) return;
            try {
                await runTransaction(db, async(t) => {
                    const sRef = doc(db, "shifts", id);
                    const s = (await t.get(sRef)).data();
                    const uRef = doc(db, "users", s.userId);
                    const u = (await t.get(uRef)).data();

                    const end = new Date();
                    const start = s.checkInTime.toDate();
                    const hrs = (end - start) / 3600000;
                    
                    if (hrs < 0.02) throw "Shift too short (< 1 min)";

                    let updates = { totalHours: (u.totalHours||0) + hrs, totalDays: (u.totalDays||0) + 1 };
                    let pay = 0;

                    if(u.role === 'member') {
                        pay = hrs * APP_CONFIG.hourlyRate;
                        const pts = Math.floor(hrs * APP_CONFIG.bonusRate);
                        const isTrain = Math.floor((new Date() - u.joinedAt.toDate())/86400000) < APP_CONFIG.trainingDays;
                        
                        if(isTrain) updates.blockedWallet = (u.blockedWallet||0) + pay;
                        else updates.mainWallet = (u.mainWallet||0) + pay;
                        
                        updates.bonusWallet = (u.bonusWallet||0) + pts;
                    }

                    t.update(sRef, { status: 'completed', checkOutTime: serverTimestamp(), hoursWorked: hrs, earnings: pay });
                    t.update(uRef, updates);
                });
                showToast("Shift Ended");
            } catch(e) { alert(e); }
        };
        
        document.getElementById('checkOutBtn').onclick = () => window.forceStop(currentShiftId);

        // Booking Logic
        document.getElementById('bookSlotBtn').onclick = async () => {
            const s = document.getElementById('bookStartTime').value;
            const e = document.getElementById('bookEndTime').value;
            if(!s || !e) return showToast("Select Timing");
            
            const isSquad = currentUserData.role === 'member';
            if(isSquad && (currentUserData.strikes||0) >= 3) return alert("Account blocked due to strikes.");

            const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate()+1);
            const dStr = tomorrow.toISOString().split('T')[0];
            const type = isSquad ? 'shift' : 'leave';

            const exist = await getDocs(query(collection(db,"shift_requests"), where("userId","==",currentUserData.uid), where("date","==",dStr)));
            if(!exist.empty) return showToast("Request already exists for tomorrow");

            await addDoc(collection(db,"shift_requests"), { 
                userId: currentUserData.uid, 
                userName: currentUserData.name, 
                date: dStr, startTime: s, endTime: e, 
                status: 'pending', type: type 
            });
            showToast("Request Sent");
        };

        // Helpers
        function getDist(lat1,lon1,lat2,lon2) {
            const R=6371; const dLat=deg2rad(lat2-lat1); const dLon=deg2rad(lon2-lon1);
            const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(deg2rad(lat1))*Math.cos(deg2rad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
            return R * (2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
        }
        function deg2rad(d) { return d*(Math.PI/180); }
        function showToast(m) { const t=document.getElementById('toast'); document.getElementById('toastMsg').innerText=m; t.classList.remove('translate-x-full'); setTimeout(()=>t.classList.add('translate-x-full'),3000); }
        
        // --- BASE ACTIONS ---
        document.getElementById('createUserForm').onsubmit = async (e) => {
            e.preventDefault();
            try {
                const cred = await createUserWithEmailAndPassword(secondaryAuth, document.getElementById('newUserEmail').value, document.getElementById('newUserPassword').value);
                await setDoc(doc(db,"users",cred.user.uid), { 
                    name: document.getElementById('newUserName').value, 
                    email: document.getElementById('newUserEmail').value, 
                    role: document.getElementById('newUserRole').value, 
                    joinedAt: serverTimestamp(), 
                    mainWallet:0, bonusWallet:0, blockedWallet:0, strikes:0, rating:5, totalHours:0, totalDays:0, leavesTaken:0 
                });
                await signOut(secondaryAuth);
                document.getElementById('createUserModal').classList.add('hidden'); e.target.reset(); showToast("User Created");
            } catch(x) { alert(x.message); }
        };

        window.deleteUser = async (uid) => { if(confirm("Delete User Data?")) await deleteDoc(doc(db,"users",uid)); };
        window.delShift = async (id) => { if(confirm("Delete Record?")) await deleteDoc(doc(db,"shifts",id)); };
        window.handleReq = async (id, st) => { st==='approved' ? await updateDoc(doc(db,"shift_requests",id),{status:st}) : await deleteDoc(doc(db,"shift_requests",id)); showToast("Updated"); };
        window.openRedeemModal = async () => {
            const s = document.getElementById('redeemUserSelect'); s.innerHTML='<option value="">Select Staff</option>';
            const snap = await getDocs(query(collection(db,"users"), where("role","==","member")));
            snap.forEach(d => { const u=d.data(); const o=document.createElement('option'); o.value=d.id; o.innerText=`${u.name} (${u.bonusWallet||0}pts)`; s.appendChild(o); });
            document.getElementById('redeemModal').classList.remove('hidden');
        };

        // Login Handler
        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            try { await signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPassword').value); }
            catch(x) { document.getElementById('authError').innerText = "Invalid Credentials"; document.getElementById('authError').classList.remove('hidden'); }
        };
        document.getElementById('logoutBtn').onclick = () => signOut(auth);

    </script>
</body>
</html>
